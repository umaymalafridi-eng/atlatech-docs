---
title: IDOR Prevention
sidebar_label: "17.1 IDOR Prevention"
sidebar_position: 1
---

# 17.1 IDOR Prevention (Insecure Direct Object Reference)

## Introduction

IDOR est une vulnérabilité qui permet à un attaquant d'accéder directement à des objets en manipulant les identifiants dans les URLs ou paramètres.

### Qu'est-ce qu'IDOR ?

**Pour les non-techniciens :** Imaginez que chaque employé a un casier numéroté. Sans protection IDOR, n'importe qui peut ouvrir le casier d'un autre simplement en changeant le numéro.

**Pour les techniciens :** IDOR se produit quand l'application expose des références internes (IDs) sans vérifier que l'utilisateur a le droit d'accéder à cette ressource.

---

## 17.1.1 État AVANT (Vulnérable)

### Problème : Accès non autorisé aux fiches employés

**Code vulnérable dans view_employee.php :**

```php
<?php
// VULNÉRABLE - Pas de vérification d'autorisation
$id = $_GET['id'];
$query = "SELECT * FROM employes WHERE id = $id";
$result = mysqli_query($conn, $query);
$employee = mysqli_fetch_assoc($result);

// Affichage direct sans vérifier les droits
echo $employee['nom'];
echo $employee['salaire']; // Données sensibles !
?>
```

**Test d'exploitation :**

```bash
# Utilisateur normal connecté en tant que karim.dev (ID=5)
# Peut voir SA fiche
curl http://192.168.112.141/atlastech/view_employee.php?id=5

# Peut aussi voir la fiche du CEO en changeant l'ID !
curl http://192.168.112.141/atlastech/view_employee.php?id=1
```

**Résultat AVANT :**
- Tous les employés peuvent voir les fiches de TOUS les autres
- Les salaires de tout le monde sont visibles
- Aucune séparation des privilèges

---

## 17.1.2 État APRÈS (Sécurisé)

### Solution 1 : Vérification des droits d'accès

**Créer le fichier authorization.php :**

```php
<?php
/**
 * Gestion des autorisations AtlasTech
 */

function can_view_employee($current_user_id, $target_employee_id) {
    global $conn;
    
    // Récupérer les infos de l'utilisateur connecté
    $query = "SELECT is_admin, departement_id FROM employes WHERE id = ?";
    $stmt = mysqli_prepare($conn, $query);
    mysqli_stmt_bind_param($stmt, "i", $current_user_id);
    mysqli_stmt_execute($stmt);
    $result = mysqli_stmt_get_result($stmt);
    $current_user = mysqli_fetch_assoc($result);
    
    // Admin peut tout voir
    if ($current_user['is_admin'] == 'OUI') {
        return true;
    }
    
    // Un employé peut voir sa propre fiche
    if ($current_user_id == $target_employee_id) {
        return true;
    }
    
    // RH peut voir tous les employés de son département
    $query_target = "SELECT departement_id FROM employes WHERE id = ?";
    $stmt2 = mysqli_prepare($conn, $query_target);
    mysqli_stmt_bind_param($stmt2, "i", $target_employee_id);
    mysqli_stmt_execute($stmt2);
    $result2 = mysqli_stmt_get_result($stmt2);
    $target = mysqli_fetch_assoc($result2);
    
    if ($current_user['departement_id'] == 4 && $target['departement_id'] == $current_user['departement_id']) {
        return true; // RH peut voir son département
    }
    
    return false; // Refus par défaut
}

function can_edit_employee($current_user_id, $target_employee_id) {
    global $conn;
    
    $query = "SELECT is_admin FROM employes WHERE id = ?";
    $stmt = mysqli_prepare($conn, $query);
    mysqli_stmt_bind_param($stmt, "i", $current_user_id);
    mysqli_stmt_execute($stmt);
    $result = mysqli_stmt_get_result($stmt);
    $current_user = mysqli_fetch_assoc($result);
    
    // Seuls les admins peuvent modifier
    return ($current_user['is_admin'] == 'OUI');
}

function can_delete_employee($current_user_id) {
    global $conn;
    
    $query = "SELECT is_admin, departement_id FROM employes WHERE id = ?";
    $stmt = mysqli_prepare($conn, $query);
    mysqli_stmt_bind_param($stmt, "i", $current_user_id);
    mysqli_stmt_execute($stmt);
    $result = mysqli_stmt_get_result($stmt);
    $user = mysqli_fetch_assoc($result);
    
    // Seuls CEO et IT peuvent supprimer
    return ($user['is_admin'] == 'OUI' && ($user['departement_id'] == 1 || $user['departement_id'] == 2));
}
?>
```

### Solution 2 : Modification de view_employee.php

**Fichier sécurisé :**

```php
<?php
session_start();
require_once 'config.php';
require_once 'authorization.php';

// Vérifier que l'utilisateur est connecté
if (!isset($_SESSION['user_id'])) {
    header("Location: login.php");
    exit;
}

$current_user_id = $_SESSION['user_id'];
$target_id = isset($_GET['id']) ? intval($_GET['id']) : 0;

// IDOR Prevention : Vérifier les droits
if (!can_view_employee($current_user_id, $target_id)) {
    http_response_code(403);
    die("Accès refusé : Vous n'avez pas les droits pour voir cette fiche.");
}

// Si autorisé, récupérer les données
$query = "SELECT e.*, d.nom as nom_departement 
          FROM employes e 
          LEFT JOIN departements d ON e.departement_id = d.id 
          WHERE e.id = ?";
$stmt = mysqli_prepare($conn, $query);
mysqli_stmt_bind_param($stmt, "i", $target_id);
mysqli_stmt_execute($stmt);
$result = mysqli_stmt_get_result($stmt);
$employee = mysqli_fetch_assoc($result);

if (!$employee) {
    die("Employé non trouvé");
}

// Masquer le salaire si pas admin
$can_view_salary = ($_SESSION['is_admin'] == 'OUI' || $_SESSION['departement_id'] == 5);
?>

<!DOCTYPE html>
<html lang="fr">
<head>
    <title>Fiche : <?php echo htmlspecialchars($employee['prenom'] . ' ' . $employee['nom']); ?></title>
</head>
<body>
    <h1><?php echo htmlspecialchars($employee['prenom'] . ' ' . $employee['nom']); ?></h1>
    <p>Poste : <?php echo htmlspecialchars($employee['poste']); ?></p>
    <p>Département : <?php echo htmlspecialchars($employee['nom_departement']); ?></p>
    
    <?php if ($can_view_salary): ?>
        <p>Salaire : <?php echo number_format($employee['salaire'], 2); ?> MAD</p>
    <?php else: ?>
        <p>Salaire : [Confidentiel]</p>
    <?php endif; ?>
</body>
</html>
```

---

## 17.1.3 Vérification de la correction

**Test 1 : Employé normal essaie de voir une autre fiche**

```bash
# Se connecter en tant que karim.dev
curl -c cookies.txt -d "utilisateur=karim.dev&mot_de_passe=DevKarim99&login=1" \
  http://192.168.112.141/atlastech/login.php

# Essayer d'accéder à la fiche du CEO (id=1)
curl -b cookies.txt http://192.168.112.141/atlastech/view_employee.php?id=1
```

**Résultat attendu :**
```
HTTP/1.1 403 Forbidden
Accès refusé : Vous n'avez pas les droits pour voir cette fiche.
```

**Test 2 : Admin peut voir toutes les fiches**

```bash
# Se connecter en tant que a.haidar (admin)
curl -c cookies.txt -d "utilisateur=a.haidar&mot_de_passe=DG2024!&login=1" \
  http://192.168.112.141/atlastech/login.php

# Accéder à n'importe quelle fiche
curl -b cookies.txt http://192.168.112.141/atlastech/view_employee.php?id=5
```

**Résultat attendu :**
```
HTTP/1.1 200 OK
[Contenu de la fiche affiché correctement]
```

---

## 17.1.4 Logs d'accès refusé

**Ajouter un log dans authorization.php :**

```php
function log_access_denied($user_id, $target_id, $action) {
    global $conn;
    
    $query = "INSERT INTO logs_access_denied (user_id, target_employee_id, action, ip_address) 
              VALUES (?, ?, ?, ?)";
    $stmt = mysqli_prepare($conn, $query);
    $ip = $_SERVER['REMOTE_ADDR'];
    mysqli_stmt_bind_param($stmt, "iiss", $user_id, $target_id, $action, $ip);
    mysqli_stmt_execute($stmt);
}
```

**Créer la table de logs :**

```sql
CREATE TABLE logs_access_denied (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    target_employee_id INT,
    action VARCHAR(50),
    ip_address VARCHAR(45),
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user (user_id),
    INDEX idx_timestamp (timestamp)
) ENGINE=InnoDB;
```

**Requête d'audit :**

```sql
-- Voir les tentatives d'accès non autorisé
SELECT 
    e1.utilisateur as tentative_par,
    e2.utilisateur as cible,
    l.action,
    l.ip_address,
    l.timestamp
FROM logs_access_denied l
LEFT JOIN employes e1 ON l.user_id = e1.id
LEFT JOIN employes e2 ON l.target_employee_id = e2.id
ORDER BY l.timestamp DESC
LIMIT 20;
```

---

## 17.1.5 Matrice de contrôle d'accès

**Tableau récapitulatif :**

| Rôle | Voir sa fiche | Voir autres fiches | Modifier fiches | Supprimer |
|------|---------------|-------------------|-----------------|-----------|
| **Employé normal** | Oui | Non | Non | Non |
| **RH** | Oui | Département RH | Département RH | Non |
| **Finance** | Oui | Voir salaires | Non | Non |
| **IT Admin** | Oui | Toutes | Toutes | Oui |
| **CEO** | Oui | Toutes | Toutes | Oui |

---

## 17.1.6 Protection supplémentaire : UUIDs

**Alternative aux IDs séquentiels :**

```sql
-- Ajouter une colonne UUID
ALTER TABLE employes ADD COLUMN uuid CHAR(36) UNIQUE;

-- Générer des UUIDs
UPDATE employes SET uuid = UUID();

-- INDEX pour performance
CREATE INDEX idx_uuid ON employes(uuid);
```

**Utilisation dans l'URL :**

```php
// Au lieu de : view_employee.php?id=5
// Utiliser : view_employee.php?uuid=550e8400-e29b-41d4-a716-446655440000
$uuid = $_GET['uuid'];
$query = "SELECT * FROM employes WHERE uuid = ?";
```

**Avantage :** Les UUIDs sont impossibles à deviner (128 bits aléatoires).

---

## Conclusion

Protection IDOR implémentée dans AtlasTech :

**Avant :**
- Accès libre à toutes les fiches
- Salaires visibles par tous
- 0% de contrôle d'accès

**Après :**
- Vérification systématique des droits
- Logs des tentatives d'accès refusé
- Matrice de permissions granulaire
- Option UUID pour obscurcissement

**Conformité :**
- OWASP A01:2021 (Broken Access Control) : Corrigé
- CIS Benchmark : Conforme

**Prochaine section :** 17.2 Directory Listing