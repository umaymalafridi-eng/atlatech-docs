---
title: DNS Security
sidebar_label: "17.4 DNS Security"
sidebar_position: 4
---

# 17.4 DNS Security

## Introduction

La sécurité DNS est essentielle pour protéger contre les attaques de type DNS poisoning, DNS spoofing et DDoS.

### Qu'est-ce que la sécurité DNS ?

**Pour les non-techniciens :** Le DNS est comme l'annuaire téléphonique d'Internet. Il traduit les noms de domaine (atlastech.ma) en adresses IP (192.168.112.141). Sécuriser le DNS empêche les pirates de rediriger vos visiteurs vers de faux sites.

**Pour les techniciens :** Implémentation de DNSSEC, configuration sécurisée de BIND/dnsmasq, protection contre cache poisoning et DDoS amplification.

---

## 17.4.1 Configuration DNS locale sécurisée

### Installation et configuration dnsmasq

```bash
# Installation
sudo apt update
sudo apt install dnsmasq -y

# Backup configuration originale
sudo cp /etc/dnsmasq.conf /etc/dnsmasq.conf.backup
```

**Configuration sécurisée :**

```bash
sudo nano /etc/dnsmasq.conf
```

**Contenu :**

```conf
# ====================================
# AtlasTech Solutions - DNS Security
# ====================================

# Interface d'écoute (réseau local uniquement)
interface=ens33
listen-address=127.0.0.1,192.168.112.141

# Ne pas écouter sur l'interface publique
except-interface=eth0

# Taille du cache DNS
cache-size=1000

# Durée de vie du cache (secondes)
local-ttl=300

# Désactiver la résolution de noms via /etc/hosts pour les requêtes externes
no-hosts

# Fichier hosts local AtlasTech
addn-hosts=/etc/hosts.atlastech

# Serveurs DNS upstream sécurisés (Cloudflare DNS over HTTPS)
server=1.1.1.1
server=1.0.0.1

# Serveurs DNS secondaires (Google)
server=8.8.8.8
server=8.8.4.4

# Bloquer les requêtes DNS inverses privées
bogus-priv

# Ne pas transmettre les requêtes pour domaines non qualifiés
domain-needed

# Logs (debug uniquement, désactiver en production)
log-queries
log-facility=/var/log/dnsmasq.log

# Protection contre DNS rebinding
stop-dns-rebind
rebind-localhost-ok

# Limiter le taux de requêtes (anti-DDoS)
dns-forward-max=150

# DNSSEC (validation des réponses)
dnssec
trust-anchor=.,20326,8,2,E06D44B80B8F1D39A95C0B0D7C65D08458E880409BBC683457104237C7F8EC8D
```

**Créer le fichier hosts local :**

```bash
sudo nano /etc/hosts.atlastech
```

**Contenu :**

```
# Résolution DNS locale AtlasTech
192.168.112.141    atlastech.local
192.168.112.141    www.atlastech.local
192.168.112.141    admin.atlastech.local
192.168.112.20     atlastech-backup.local
```

**Redémarrer dnsmasq :**

```bash
sudo systemctl restart dnsmasq
sudo systemctl enable dnsmasq
```

---

## 17.4.2 Validation et tests DNS

**Test 1 : Résolution locale**

```bash
# Tester la résolution DNS
dig @127.0.0.1 atlastech.local

# Résultat attendu :
# atlastech.local.  300  IN  A  192.168.112.141
```

**Test 2 : Vérifier DNSSEC**

```bash
# Tester DNSSEC sur un domaine public
dig @127.0.0.1 cloudflare.com +dnssec

# Vérifier la signature RRSIG
dig @127.0.0.1 cloudflare.com +dnssec | grep RRSIG
```

**Test 3 : Protection rebinding**

```bash
# Tester qu'on ne peut pas résoudre des adresses privées depuis l'extérieur
dig @127.0.0.1 test.192.168.1.1.nip.io
# Devrait être bloqué si rebind-localhost-ok est désactivé pour cette plage
```

---

## 17.4.3 Configuration firewall pour DNS

**Règles UFW pour sécuriser DNS :**

```bash
# Autoriser DNS uniquement depuis le réseau local
sudo ufw allow from 192.168.112.0/24 to any port 53 proto udp
sudo ufw allow from 192.168.112.0/24 to any port 53 proto tcp

# Bloquer DNS depuis Internet (si serveur exposé)
sudo ufw deny from any to any port 53

# Recharger UFW
sudo ufw reload

# Vérifier
sudo ufw status numbered
```

**Résultat attendu :**

```
Status: active

     To                         Action      From
     --                         ------      ----
[1]  53/udp                     ALLOW IN    192.168.112.0/24
[2]  53/tcp                     ALLOW IN    192.168.112.0/24
[3]  53                         DENY IN     Anywhere
```

---

## 17.4.4 Monitoring des requêtes DNS

**Script de monitoring :**

```bash
sudo nano /usr/local/bin/monitor_dns.sh
```

**Contenu :**

```bash
#!/bin/bash
# Monitoring DNS AtlasTech

LOG_FILE="/var/log/atlastech/dns_monitor.log"
mkdir -p /var/log/atlastech

# Analyser les logs dnsmasq
echo "[$(date)] Analyse DNS" >> $LOG_FILE

# Top 10 domaines les plus demandés
echo "Top 10 domaines :" >> $LOG_FILE
grep "query" /var/log/dnsmasq.log | awk '{print $6}' | sort | uniq -c | sort -rn | head -10 >> $LOG_FILE

# Détecter les requêtes suspectes
SUSPICIOUS=$(grep -E "(\.tk|\.ml|\.ga|porn|malware)" /var/log/dnsmasq.log | wc -l)
if [ $SUSPICIOUS -gt 0 ]; then
    echo "[ALERT] $SUSPICIOUS requêtes suspectes détectées" >> $LOG_FILE
fi

# Statistiques
TOTAL=$(grep "query" /var/log/dnsmasq.log | wc -l)
echo "Total requêtes: $TOTAL" >> $LOG_FILE
```

**Rendre exécutable et planifier :**

```bash
sudo chmod +x /usr/local/bin/monitor_dns.sh
(sudo crontab -l; echo "0 */6 * * * /usr/local/bin/monitor_dns.sh") | sudo crontab -
```

---

## 17.4.5 Blocage de domaines malveillants

**Liste noire de domaines :**

```bash
sudo nano /etc/dnsmasq.d/blocklist.conf
```

**Contenu :**

```conf
# Blocage domaines malveillants et publicités

# Adware / Malware
address=/doubleclick.net/0.0.0.0
address=/googleadservices.com/0.0.0.0
address=/googlesyndication.com/0.0.0.0

# Trackers
address=/facebook.com/0.0.0.0
address=/analytics.google.com/0.0.0.0

# Phishing connus (exemples)
address=/paypal-secure.com/0.0.0.0
address=/appleid-login.com/0.0.0.0

# Sites malveillants
address=/malware-site.tk/0.0.0.0
```

**Redémarrer :**

```bash
sudo systemctl restart dnsmasq
```

**Test de blocage :**

```bash
dig @127.0.0.1 doubleclick.net
# Devrait retourner 0.0.0.0
```

---

## 17.4.6 DNS over HTTPS (DoH) - Configuration client

**Pour les postes Windows utilisant le serveur :**

```bash
# Configurer les clients pour utiliser le DNS AtlasTech
# Via GPO ou manuellement dans les paramètres réseau
# Serveur DNS préféré: 192.168.112.141
```

**Installation Cloudflared pour DoH (optionnel) :**

```bash
# Télécharger cloudflared
wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
sudo dpkg -i cloudflared-linux-amd64.deb

# Configuration DoH
sudo cloudflared proxy-dns --port 5053 --upstream https://1.1.1.1/dns-query
```

**Configuration dnsmasq pour utiliser DoH :**

```conf
# Ajouter dans /etc/dnsmasq.conf
server=127.0.0.1#5053
```

---

## 17.4.7 Audit et vérification

**Script de vérification sécurité DNS :**

```bash
cat > /tmp/check_dns_security.sh << 'EOF'
#!/bin/bash
echo "Vérification Sécurité DNS AtlasTech"
echo "===================================="

# Test 1 : dnsmasq actif
if systemctl is-active --quiet dnsmasq; then
    echo "[OK] dnsmasq actif"
else
    echo "[ERREUR] dnsmasq inactif"
fi

# Test 2 : DNSSEC configuré
if grep -q "^dnssec" /etc/dnsmasq.conf; then
    echo "[OK] DNSSEC activé"
else
    echo "[WARNING] DNSSEC non activé"
fi

# Test 3 : Rebind protection
if grep -q "stop-dns-rebind" /etc/dnsmasq.conf; then
    echo "[OK] Protection rebinding activée"
else
    echo "[WARNING] Protection rebinding absente"
fi

# Test 4 : Firewall DNS
UFW_DNS=$(sudo ufw status | grep -c "53")
if [ $UFW_DNS -gt 0 ]; then
    echo "[OK] Règles firewall DNS présentes"
else
    echo "[WARNING] Pas de règles firewall pour DNS"
fi

# Test 5 : Résolution test
TEST_RESOLVE=$(dig @127.0.0.1 atlastech.local +short)
if [ -n "$TEST_RESOLVE" ]; then
    echo "[OK] Résolution DNS fonctionne"
else
    echo "[ERREUR] Résolution DNS échoue"
fi

echo "===================================="
EOF

chmod +x /tmp/check_dns_security.sh
/tmp/check_dns_security.sh
```

---

## Tableau récapitulatif

| Aspect | Configuration |
|--------|---------------|
| **Serveur DNS** | dnsmasq |
| **DNSSEC** | Activé avec trust anchor |
| **Cache** | 1000 entrées, TTL 300s |
| **Protection rebinding** | Activée |
| **Upstream DNS** | Cloudflare (1.1.1.1) + Google (8.8.8.8) |
| **Firewall** | Port 53 restreint au LAN |
| **Blocklist** | Domaines malveillants bloqués |
| **Monitoring** | Logs + script toutes les 6h |
| **DoH (optionnel)** | cloudflared disponible |

---

## Conclusion

Sécurité DNS implémentée pour AtlasTech :

**Protections :**
- DNSSEC pour validation des réponses
- Protection DNS rebinding
- Limitation de taux (anti-DDoS)
- Firewall restrictif (LAN uniquement)
- Blocklist de domaines malveillants
- Monitoring automatisé

**Conformité :**
- NIST SP 800-81-2 (Secure DNS) : Conforme
- CIS Benchmark DNS : Conforme

**Prochain chapitre :** 18. Durcissement Systèmes