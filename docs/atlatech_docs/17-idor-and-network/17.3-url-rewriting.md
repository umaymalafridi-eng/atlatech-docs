---
title: URL Rewriting
sidebar_label: "17.3 URL Rewriting"
sidebar_position: 3
---

# 17.3 URL Rewriting - Masquage des extensions .php

## Introduction

L'URL Rewriting permet de masquer les extensions de fichiers (.php) dans les URLs, améliorant la sécurité par obscurité et l'esthétique des URLs.

### Pourquoi masquer les extensions ?

**Pour les non-techniciens :** Au lieu d'afficher `login.php`, on affiche simplement `login`. Cela cache la technologie utilisée et rend le site plus professionnel.

**Pour les techniciens :** Masquer l'extension .php empêche les attaquants de savoir immédiatement quelle technologie vous utilisez, réduisant la surface d'attaque ciblée.

---

## 17.3.1 État AVANT

**URLs actuelles (exposent la technologie) :**

```
http://192.168.112.141/atlastech/login.php
http://192.168.112.141/atlastech/dashboard.php
http://192.168.112.141/atlastech/view_employee.php?id=5
http://192.168.112.141/atlastech/add_employee.php
```

**Problèmes :**
- Extension .php visible → révèle PHP comme technologie
- Facilite les scans automatisés de vulnérabilités PHP
- URLs moins professionnelles

---

## 17.3.2 État APRÈS - Configuration Apache mod_rewrite

### Étape 1 : Activer mod_rewrite

```bash
# Activer le module Apache
sudo a2enmod rewrite

# Vérifier l'activation
apache2ctl -M | grep rewrite
```

**Résultat attendu :**
```
rewrite_module (shared)
```

### Étape 2 : Configuration .htaccess pour AtlasTech

```bash
sudo nano /var/www/html/atlastech/.htaccess
```

**Contenu complet :**

```apache
# ====================================
# AtlasTech Solutions - URL Rewriting
# ====================================

# Activer le moteur de réécriture
RewriteEngine On
RewriteBase /atlastech/

# ====================================
# 1. MASQUAGE EXTENSION .php
# ====================================

# Si le fichier existe avec .php, le servir
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}.php -f
RewriteRule ^(.+)$ $1.php [L,QSA]

# ====================================
# 2. REDIRECTION www vers non-www
# ====================================

RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
RewriteRule ^(.*)$ http://%1/$1 [R=301,L]

# ====================================
# 3. FORCER HTTPS (production)
# ====================================

# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# ====================================
# 4. URLs PROPRES POUR CRUD
# ====================================

# view/5 → view_employee.php?id=5
RewriteRule ^view/([0-9]+)$ view_employee.php?id=$1 [L,QSA]

# edit/5 → edit_employee.php?id=5
RewriteRule ^edit/([0-9]+)$ edit_employee.php?id=$1 [L,QSA]

# delete/5 → delete_employee.php?id=5
RewriteRule ^delete/([0-9]+)$ delete_employee.php?id=$1 [L,QSA]

# ====================================
# 5. PROTECTION FICHIERS SENSIBLES
# ====================================

# Bloquer .htaccess, .git, .env
RedirectMatch 403 /\.(?!well-known).*$

# Bloquer fichiers de backup
RedirectMatch 403 .*\.(bak|sql|log|old)$
```

### Étape 3 : Tester la réécriture

**Test 1 : Accès sans extension**

```bash
# AVANT : Nécessitait .php
curl http://192.168.112.141/atlastech/login.php

# APRÈS : Fonctionne sans .php
curl http://192.168.112.141/atlastech/login

# Les deux fonctionnent maintenant
curl -I http://192.168.112.141/atlastech/dashboard
```

**Résultat attendu :**
```
HTTP/1.1 200 OK
Date: Mon, 10 Feb 2026 10:00:00 GMT
Server: Apache/2.4.52 (Ubuntu)
Content-Type: text/html; charset=UTF-8
```

**Test 2 : URLs propres pour CRUD**

```bash
# Nouvelle syntaxe propre
curl http://192.168.112.141/atlastech/view/5
curl http://192.168.112.141/atlastech/edit/12
curl http://192.168.112.141/atlastech/delete/8
```

---

## 17.3.3 Mise à jour des liens dans l'application

### Modification du dashboard.php

**AVANT :**
```php
<a href="view_employee.php?id=<?php echo $row['id']; ?>">Voir</a>
<a href="edit_employee.php?id=<?php echo $row['id']; ?>">Modifier</a>
```

**APRÈS :**
```php
<a href="view/<?php echo $row['id']; ?>">Voir</a>
<a href="edit/<?php echo $row['id']; ?>">Modifier</a>
```

### Modification du menu navigation

**Créer helpers.php :**

```php
<?php
function url($path) {
    // Retourne l'URL sans extension .php
    return '/atlastech/' . ltrim($path, '/');
}
?>
```

**Utilisation :**
```php
<a href="<?php echo url('dashboard'); ?>">Tableau de bord</a>
<a href="<?php echo url('add_employee'); ?>">Nouvel employé</a>
<a href="<?php echo url('logout'); ?>">Déconnexion</a>
```

---

## 17.3.4 URLs SEO-friendly (optionnel)

### Configuration avancée pour URLs textuelles

```apache
# employee/john-doe au lieu de view/5
RewriteRule ^employee/([a-z-]+)$ view_employee_by_slug.php?slug=$1 [L,QSA]

# department/it au lieu de department.php?name=it
RewriteRule ^department/([a-z]+)$ department.php?slug=$1 [L,QSA]
```

**Ajouter colonne slug dans la base :**

```sql
ALTER TABLE employes ADD COLUMN slug VARCHAR(100) UNIQUE;

UPDATE employes 
SET slug = LOWER(CONCAT(prenom, '-', nom));

-- Exemple : 'Oumayma Lafridi' → 'oumayma-lafridi'
```

**Fichier view_employee_by_slug.php :**

```php
<?php
require_once 'config.php';
$slug = $_GET['slug'];
$query = "SELECT * FROM employes WHERE slug = ?";
$stmt = mysqli_prepare($conn, $query);
mysqli_stmt_bind_param($stmt, "s", $slug);
// ... reste du code
?>
```

**Nouvelle URL :**
```
http://192.168.112.141/atlastech/employee/oumayma-lafridi
```

---

## 17.3.5 Gestion des erreurs 404

**Personnaliser la page 404 :**

```bash
sudo nano /var/www/html/atlastech/error_404.php
```

**Contenu :**

```php
<?php
http_response_code(404);
?>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Page non trouvée - AtlasTech</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        .error-box {
            background: white;
            padding: 60px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #e74c3c; font-size: 6em; margin: 0; }
        h2 { color: #2c3e50; }
        a {
            display: inline-block;
            margin-top: 20px;
            padding: 15px 40px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="error-box">
        <h1>404</h1>
        <h2>Page non trouvée</h2>
        <p>La page que vous recherchez n'existe pas.</p>
        <a href="/atlastech/dashboard">Retour au tableau de bord</a>
    </div>
</body>
</html>
```

**Ajouter dans .htaccess :**

```apache
ErrorDocument 404 /atlastech/error_404.php
```

---

## 17.3.6 Vérification et debug

**Test complet du rewriting :**

```bash
# Script de test automatisé
cat > /tmp/test_rewriting.sh << 'EOF'
#!/bin/bash
echo "Test URL Rewriting AtlasTech"
echo "=============================="

# Test 1 : Page sans extension
echo -n "Test login sans .php : "
STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://192.168.112.141/atlastech/login)
if [ "$STATUS" = "200" ]; then
    echo "OK"
else
    echo "ECHEC (HTTP $STATUS)"
fi

# Test 2 : URL propre CRUD
echo -n "Test view/5 : "
STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://192.168.112.141/atlastech/view/5)
if [ "$STATUS" = "200" ] || [ "$STATUS" = "302" ]; then
    echo "OK"
else
    echo "ECHEC (HTTP $STATUS)"
fi

# Test 3 : Protection fichiers
echo -n "Test blocage .sql : "
STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://192.168.112.141/atlastech/backup.sql)
if [ "$STATUS" = "403" ]; then
    echo "OK (bloqué)"
else
    echo "ATTENTION (HTTP $STATUS)"
fi

echo "=============================="
EOF

chmod +x /tmp/test_rewriting.sh
/tmp/test_rewriting.sh
```

**Résultat attendu :**
```
Test URL Rewriting AtlasTech
==============================
Test login sans .php : OK
Test view/5 : OK
Test blocage .sql : OK (bloqué)
==============================
```

---

## 17.3.7 Logs de débogage

**Activer les logs de réécriture (temporairement) :**

```apache
# Ajouter dans .htaccess
RewriteLog "/var/log/apache2/rewrite.log"
RewriteLogLevel 3
```

**Analyser les logs :**

```bash
tail -f /var/log/apache2/rewrite.log
```

**Désactiver après debug (impact performance) :**

```apache
# Commenter ou supprimer les lignes RewriteLog
```

---

## Tableau récapitulatif

| Aspect | Avant | Après |
|--------|-------|-------|
| **Extension visible** | login.php | login |
| **URLs CRUD** | view_employee.php?id=5 | view/5 |
| **Technologie exposée** | Oui (PHP visible) | Non (masqué) |
| **SEO-friendly** | Non | Oui (optionnel) |
| **Page 404** | Apache par défaut | Personnalisée |

---

## Conclusion

URL Rewriting implémenté pour AtlasTech :

**Bénéfices :**
- Extensions .php masquées
- URLs propres et professionnelles (view/5 au lieu de view_employee.php?id=5)
- Obscurité technologique (PHP non révélé)
- Protection fichiers sensibles (.sql, .bak bloqués)
- Page 404 personnalisée

**Conformité :**
- CIS Apache Benchmark 5.13 : Conforme
- OWASP ASVS V14.5 : Conforme

**Prochaine section :** 17.4 DNS Security