---
id: input-validation
title: Validation des Entrées
sidebar_label: "15.8 Validation des Entrées"
sidebar_position: 8
---

# 15.8 Validation des Entrées

## Principe Fondamental

**Never Trust User Input** - Ne jamais faire confiance aux données utilisateur.

Toute donnée provenant de l'extérieur (formulaires, URL, cookies, headers HTTP) doit être validée côté serveur.

:::danger Règle d'Or
La validation JavaScript côté client est pour l'expérience utilisateur uniquement.
La validation côté serveur est OBLIGATOIRE pour la sécurité.
:::

---

## Types de Validation

### 15.8.1 Validation avec filter_var()

```php
<?php
// Email
$email = $_POST['email'];
if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
    die("Email invalide");
}

// URL
$website = $_POST['website'];
if (!filter_var($website, FILTER_VALIDATE_URL)) {
    die("URL invalide");
}

// Entier positif
$age = $_POST['age'];
if (!filter_var($age, FILTER_VALIDATE_INT, ['options' => ['min_range' => 18, 'max_range' => 70]])) {
    die("Âge invalide (18-70)");
}

// Adresse IP
$ip = $_SERVER['REMOTE_ADDR'];
if (!filter_var($ip, FILTER_VALIDATE_IP, FILTER_FLAG_IPV4)) {
    die("IP invalide");
}

// Booléen
$accept_terms = $_POST['accept_terms'];
$is_accepted = filter_var($accept_terms, FILTER_VALIDATE_BOOLEAN, FILTER_NULL_ON_FAILURE);
if ($is_accepted === null) {
    die("Valeur booléenne invalide");
}
?>
```

### 15.8.2 Validation avec Expressions Régulières

```php
<?php
/**
 * Classe de validation pour AtlasTech RH
 */
class Validator {
    
    /**
     * CIN marocain (A123456 ou AB123456)
     */
    public static function validateCIN($cin) {
        return preg_match('/^[A-Z]{1,2}[0-9]{6}$/', $cin) === 1;
    }
    
    /**
     * Téléphone marocain (+2126XXXXXXXX ou +2127XXXXXXXX ou 06XXXXXXXX ou 07XXXXXXXX)
     */
    public static function validatePhoneMA($phone) {
        return preg_match('/^(\+212|0)[67][0-9]{8}$/', $phone) === 1;
    }
    
    /**
     * Code postal marocain (5 chiffres)
     */
    public static function validatePostalCodeMA($code) {
        return preg_match('/^[0-9]{5}$/', $code) === 1;
    }
    
    /**
     * Nom/Prénom (lettres, espaces, tirets, apostrophes)
     */
    public static function validateName($name) {
        return preg_match('/^[a-zA-ZÀ-ÿ\s\-\']{2,50}$/u', $name) === 1;
    }
    
    /**
     * IBAN marocain
     */
    public static function validateIBAN($iban) {
        // Format IBAN Maroc : MA + 24 chiffres
        return preg_match('/^MA[0-9]{24}$/', str_replace(' ', '', $iban)) === 1;
    }
    
    /**
     * Date au format YYYY-MM-DD
     */
    public static function validateDate($date) {
        $d = DateTime::createFromFormat('Y-m-d', $date);
        return $d && $d->format('Y-m-d') === $date;
    }
    
    /**
     * Salaire (positif, max 2 décimales)
     */
    public static function validateSalary($amount) {
        return preg_match('/^[0-9]+(\.[0-9]{1,2})?$/', $amount) === 1 && $amount > 0;
    }
}

// Utilisation
if (!Validator::validateCIN($_POST['cin'])) {
    $errors[] = "CIN invalide (format attendu : A123456)";
}

if (!Validator::validatePhoneMA($_POST['telephone'])) {
    $errors[] = "Numéro de téléphone marocain invalide";
}
?>
```

### 15.8.3 Validation Complète d'un Formulaire

```php
<?php
/**
 * Validation du formulaire d'ajout d'employé
 */
function validateEmployeeForm($data) {
    $errors = [];
    
    // CIN (obligatoire)
    if (empty($data['cin'])) {
        $errors['cin'] = "Le CIN est obligatoire";
    } elseif (!Validator::validateCIN($data['cin'])) {
        $errors['cin'] = "Format CIN invalide (ex: A123456)";
    }
    
    // Prénom (obligatoire, 2-50 caractères)
    if (empty($data['prenom'])) {
        $errors['prenom'] = "Le prénom est obligatoire";
    } elseif (!Validator::validateName($data['prenom'])) {
        $errors['prenom'] = "Prénom invalide (2-50 caractères, lettres uniquement)";
    }
    
    // Nom (obligatoire, 2-50 caractères)
    if (empty($data['nom'])) {
        $errors['nom'] = "Le nom est obligatoire";
    } elseif (!Validator::validateName($data['nom'])) {
        $errors['nom'] = "Nom invalide (2-50 caractères, lettres uniquement)";
    }
    
    // Email (obligatoire, format valide)
    if (empty($data['email'])) {
        $errors['email'] = "L'email est obligatoire";
    } elseif (!filter_var($data['email'], FILTER_VALIDATE_EMAIL)) {
        $errors['email'] = "Format email invalide";
    }
    
    // Téléphone (optionnel, mais si fourni doit être valide)
    if (!empty($data['telephone'])) {
        if (!Validator::validatePhoneMA($data['telephone'])) {
            $errors['telephone'] = "Numéro marocain invalide (format: +212XXXXXXXXX ou 0XXXXXXXXX)";
        }
    }
    
    // Date de naissance (obligatoire, format + âge réaliste)
    if (empty($data['date_naissance'])) {
        $errors['date_naissance'] = "La date de naissance est obligatoire";
    } elseif (!Validator::validateDate($data['date_naissance'])) {
        $errors['date_naissance'] = "Format de date invalide (YYYY-MM-DD)";
    } else {
        $birthdate = new DateTime($data['date_naissance']);
        $today = new DateTime();
        $age = $today->diff($birthdate)->y;
        
        if ($age < 18) {
            $errors['date_naissance'] = "L'employé doit avoir au moins 18 ans";
        } elseif ($age > 70) {
            $errors['date_naissance'] = "Âge irréaliste (>70 ans)";
        }
    }
    
    // Département ID (obligatoire, entier positif)
    if (empty($data['departement_id'])) {
        $errors['departement_id'] = "Le département est obligatoire";
    } elseif (!filter_var($data['departement_id'], FILTER_VALIDATE_INT, ['options' => ['min_range' => 1]])) {
        $errors['departement_id'] = "ID département invalide";
    }
    
    // Poste ID (obligatoire, entier positif)
    if (empty($data['poste_id'])) {
        $errors['poste_id'] = "Le poste est obligatoire";
    } elseif (!filter_var($data['poste_id'], FILTER_VALIDATE_INT, ['options' => ['min_range' => 1]])) {
        $errors['poste_id'] = "ID poste invalide";
    }
    
    return $errors;
}

// Utilisation dans le formulaire
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $errors = validateEmployeeForm($_POST);
    
    if (empty($errors)) {
        // Données valides, procéder à l'insertion
        // ...
    } else {
        // Afficher les erreurs
        foreach ($errors as $field => $message) {
            echo "<p class='error'>$message</p>";
        }
    }
}
?>
```

---

## Sanitization (Nettoyage)

### 15.8.4 Différence Validation vs Sanitization

- **Validation** : Vérifier si la donnée est conforme (accepter ou rejeter)
- **Sanitization** : Nettoyer la donnée (supprimer/remplacer les caractères dangereux)

```php
<?php
// Sanitization avec filter_var()

// Nettoyer une chaîne (supprimer balises HTML)
$name = filter_var($_POST['name'], FILTER_SANITIZE_STRING);

// Nettoyer un email
$email = filter_var($_POST['email'], FILTER_SANITIZE_EMAIL);

// Nettoyer une URL
$url = filter_var($_POST['url'], FILTER_SANITIZE_URL);

// Supprimer tous les caractères sauf lettres, chiffres, espaces
$clean_input = preg_replace('/[^a-zA-Z0-9\s]/', '', $_POST['input']);

// Limiter la longueur
$limited = substr($_POST['comment'], 0, 500);
?>
```

---

## Validation Côté Client (JavaScript)

### 15.8.5 Validation JavaScript (UX uniquement)

```html
<script>
/**
 * Validation côté client pour l'expérience utilisateur
 * NE PAS compter dessus pour la sécurité !
 */

function validateFormEmploye() {
    const cin = document.getElementById('cin').value;
    const prenom = document.getElementById('prenom').value;
    const email = document.getElementById('email').value;
    const telephone = document.getElementById('telephone').value;
    
    let errors = [];
    
    // CIN
    if (!/^[A-Z]{1,2}[0-9]{6}$/.test(cin)) {
        errors.push("CIN invalide (format: A123456)");
    }
    
    // Prénom
    if (prenom.length < 2 || prenom.length > 50) {
        errors.push("Prénom doit faire entre 2 et 50 caractères");
    }
    
    // Email
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        errors.push("Email invalide");
    }
    
    // Téléphone marocain
    if (telephone && !/^(\+212|0)[67][0-9]{8}$/.test(telephone)) {
        errors.push("Téléphone invalide (format: +212XXXXXXXXX ou 0XXXXXXXXX)");
    }
    
    if (errors.length > 0) {
        alert(errors.join("\n"));
        return false; // Empêcher la soumission
    }
    
    return true;
}
</script>

<form method="POST" onsubmit="return validateFormEmploye()">
    <input type="text" id="cin" name="cin" required>
    <input type="text" id="prenom" name="prenom" required>
    <input type="email" id="email" name="email" required>
    <input type="tel" id="telephone" name="telephone">
    <button type="submit">Valider</button>
</form>
```

---

## Tests de Validation

### 15.8.6 Tests Unitaires

```php
<?php
/**
 * Tests unitaires de validation
 */
class ValidatorTest {
    
    public static function testCIN() {
        assert(Validator::validateCIN('A123456') === true, "CIN valide échoué");
        assert(Validator::validateCIN('AB123456') === true, "CIN 2 lettres échoué");
        assert(Validator::validateCIN('12345678') === false, "CIN sans lettre accepté");
        assert(Validator::validateCIN('A12345') === false, "CIN trop court accepté");
        echo "✓ Tests CIN passés\n";
    }
    
    public static function testPhone() {
        assert(Validator::validatePhoneMA('+212612345678') === true);
        assert(Validator::validatePhoneMA('0612345678') === true);
        assert(Validator::validatePhoneMA('+212512345678') === false); // 5 non valide
        assert(Validator::validatePhoneMA('06123456') === false); // trop court
        echo "✓ Tests Téléphone passés\n";
    }
    
    public static function runAll() {
        self::testCIN();
        self::testPhone();
        echo "Tous les tests passés !\n";
    }
}

// Exécution des tests
ValidatorTest::runAll();
?>
```

---

## Résumé

### Checklist de Validation

- [ ] Validation côté serveur OBLIGATOIRE
- [ ] Validation côté client pour l'UX (optionnel)
- [ ] Utiliser filter_var() pour types standards
- [ ] Utiliser regex pour formats spécifiques
- [ ] Valider les contraintes métier (âge, salaire, etc.)
- [ ] Sanitizer les données avant affichage (htmlspecialchars)
- [ ] Logger les tentatives de données invalides
- [ ] Messages d'erreur clairs pour l'utilisateur

---

:::tip Prochaine Section
**15.9 Logging Sécurisé** : Audit et traçabilité des actions.
:::