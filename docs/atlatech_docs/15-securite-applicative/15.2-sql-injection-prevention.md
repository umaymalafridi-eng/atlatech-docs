---
id: sql-injection-prevention
title: Prévention des Injections SQL
sidebar_label: "15.2 SQL Injection Prevention"
sidebar_position: 2
---

# 15.2 Prévention des Injections SQL

## Introduction aux Injections SQL

### Qu'est-ce qu'une Injection SQL ?

L'injection SQL est une technique d'attaque qui permet à un attaquant de manipuler les requêtes SQL exécutées par une application web.

**Impact d'une injection SQL réussie :**

- Accès non autorisé à la base de données complète
- Vol de données sensibles (mots de passe, informations personnelles, salaires)
- Modification ou suppression de données critiques
- Contournement de l'authentification
- Prise de contrôle du serveur de base de données
- Installation de backdoors (portes dérobées)

:::danger Gravité Critique
Selon l'OWASP Top 10 2021, les injections SQL font partie de la catégorie **A03:2021 – Injection**.

**Score CVSS v3.1 :** 9.8/10 (CRITICAL)
:::

---

## État Actuel : Code Vulnérable (AVANT)

### 15.2.1 Vulnérabilité dans l'Authentification

**Fichier `/var/www/html/crud-rh/login.php` (VERSION VULNÉRABLE) :**

```php
<?php
session_start();

$conn = new mysqli("192.168.30.10", "webapp_rh", "password123", "atlastech_rh");

$username = $_POST['username'];
$password = $_POST['password'];

// VULNÉRABILITÉ : Concaténation directe des variables dans la requête SQL
$sql = "SELECT * FROM users_rh 
        WHERE username = '$username' 
          AND password = '$password'";

$result = $conn->query($sql);

if ($result->num_rows > 0) {
    $_SESSION['logged_in'] = true;
    header("Location: /employes/liste.php");
} else {
    echo "Identifiants incorrects";
}
?>
```

### Démonstration d'Attaque

```bash
curl -X POST https://rh-interne.atlastech.local/login.php \
  -d "username=admin' OR '1'='1&password=nimporte_quoi"
```

**Requête SQL résultante (PIRATÉE) :**

```sql
SELECT * FROM users_rh 
WHERE username = 'admin' OR '1'='1'   -- TOUJOURS VRAIE !
  AND password = 'nimporte_quoi'
```

**Vérification en base de données :**

```sql
mysql -u root -p -h 192.168.30.10
USE atlastech_rh;

SELECT * FROM users_rh 
WHERE username = 'admin' OR '1'='1' 
  AND password = 'nimporte_quoi';

-- Résultat : retourne TOUTES les lignes !
```

### 15.2.2 Vulnérabilité dans l'Affichage des Employés

```php
<?php
$employe_id = $_GET['id'];

// VULNÉRABILITÉ : Utilisation directe de la variable
$sql = "SELECT * FROM employes WHERE id = $employe_id";
$result = $conn->query($sql);
?>
```

**Exploitation UNION-based :**

```bash
https://rh-interne.atlastech.local/employes/voir_detail.php?id=5%20UNION%20SELECT%20username,password,email,1,1,1%20FROM%20users_rh--
```

### 15.2.3 Vulnérabilité dans la Recherche

```php
<?php
$search_term = $_POST['search'];

// VULNÉRABILITÉ : LIKE sans échappement
$sql = "SELECT * FROM employes 
        WHERE nom LIKE '%$search_term%' 
           OR prenom LIKE '%$search_term%'";
?>
```

---

## Solution : Requêtes Préparées avec PDO (APRÈS)

### 15.2.4 Principe des Requêtes Préparées

```
Étape 1 : Préparation de la requête (avec placeholders)
    SQL Template : "SELECT * FROM employes WHERE id = :id"
                                                    ^
                                            Paramètre nommé

Étape 2 : Liaison des valeurs (binding)
    PDO traite la valeur comme une DONNÉE, PAS comme du CODE SQL

Étape 3 : Exécution sécurisée
```

### 15.2.5 Configuration PDO

**Fichier `/var/www/html/crud-rh/config/database.php` :**

```php
<?php
define('DB_HOST', '192.168.30.10');
define('DB_NAME', 'atlastech_rh');
define('DB_USER', 'webapp_rh');
define('DB_PASS', 'P@ssw0rd_C0mpl3x3_2024!');
define('DB_CHARSET', 'utf8mb4');

$dsn = "mysql:host=" . DB_HOST . ";dbname=" . DB_NAME . ";charset=" . DB_CHARSET;

$options = [
    PDO::ATTR_ERRMODE            => PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
    PDO::ATTR_EMULATE_PREPARES   => false,
    PDO::ATTR_PERSISTENT         => false,
    PDO::ATTR_TIMEOUT            => 5
];

try {
    $pdo = new PDO($dsn, DB_USER, DB_PASS, $options);
    $pdo->exec("SET time_zone = '+00:00'");
} catch (PDOException $e) {
    error_log("Erreur BDD : " . $e->getMessage());
    die("Erreur de connexion. Contactez l'administrateur.");
}
?>
```

### 15.2.6 Authentification Sécurisée

```php
<?php
session_start();
require_once 'config/database.php';

$username = trim($_POST['username'] ?? '');
$password = $_POST['password'] ?? '';

if (empty($username) || empty($password)) {
    $_SESSION['error'] = "Tous les champs sont obligatoires";
    header("Location: /login.php");
    exit;
}

try {
    $sql = "SELECT id, username, password_hash, role 
            FROM users_rh 
            WHERE username = :username 
            LIMIT 1";
    
    $stmt = $pdo->prepare($sql);
    $stmt->bindParam(':username', $username, PDO::PARAM_STR);
    $stmt->execute();
    $user = $stmt->fetch();
    
    if ($user && password_verify($password, $user['password_hash'])) {
        session_regenerate_id(true);
        $_SESSION['user_id']   = $user['id'];
        $_SESSION['username']  = $user['username'];
        $_SESSION['role']      = $user['role'];
        $_SESSION['logged_in'] = true;
        header("Location: /employes/liste.php");
        exit;
    } else {
        $_SESSION['error'] = "Identifiants incorrects";
        header("Location: /login.php");
        exit;
    }
    
} catch (PDOException $e) {
    error_log("Erreur SQL login : " . $e->getMessage());
    $_SESSION['error'] = "Une erreur est survenue.";
    header("Location: /login.php");
    exit;
}
?>
```

**Test — injection SQL doit échouer :**

```bash
curl -X POST https://rh-interne.atlastech.local/login.php \
  -d "username=admin' OR '1'='1&password=test"

# PDO traite la valeur comme chaîne littérale
# Résultat : Aucun utilisateur trouvé — injection échouée !
```

### 15.2.7 Affichage Sécurisé

```php
<?php
$employe_id = $_GET['id'] ?? null;

if (!filter_var($employe_id, FILTER_VALIDATE_INT, ["options" => ["min_range" => 1]])) {
    http_response_code(400);
    die("ID employé invalide");
}

$sql = "SELECT e.*, d.nom_departement, p.titre_poste
        FROM employes e
        LEFT JOIN departements d ON e.departement_id = d.id
        LEFT JOIN postes p ON e.poste_id = p.id
        WHERE e.id = ?
        LIMIT 1";

$stmt = $pdo->prepare($sql);
$stmt->execute([$employe_id]);
$employe = $stmt->fetch();
?>
```

### 15.2.8 Recherche Sécurisée avec LIKE

```php
<?php
$search_term = trim($_POST['search'] ?? '');

$search_escaped = str_replace(['%', '_'], ['\%', '\_'], $search_term);
$search_pattern = '%' . $search_escaped . '%';

$sql = "SELECT id, nom, prenom, email
        FROM employes
        WHERE nom LIKE :search OR prenom LIKE :search
        ORDER BY nom LIMIT 50";

$stmt = $pdo->prepare($sql);
$stmt->bindParam(':search', $search_pattern, PDO::PARAM_STR);
$stmt->execute();
$resultats = $stmt->fetchAll();
?>
```

---

## Tests de Sécurité

### 15.2.9 SQLMap

```bash
# Test sur la version VULNÉRABLE
sqlmap -u "https://rh-interne.atlastech.local/employes/voir_detail.php?id=5" \
       --cookie="PHPSESSID=abc123" --batch --dbs

# Résultat : [INFO] 3 databases found

# Test sur la version SÉCURISÉE (PDO)
sqlmap -u "https://rh-interne.atlastech.local/employes/voir_detail.php?id=5" \
       --cookie="PHPSESSID=xyz789" --batch --dbs

# Résultat : [CRITICAL] all tested parameters do not appear to be injectable
```

### 15.2.10 Checklist

```bash
#!/bin/bash
echo "=== Vérification Sécurité SQL ==="

grep -r "SELECT.*\$" /var/www/html/crud-rh/*.php
grep -r "->prepare(" /var/www/html/crud-rh/*.php | wc -l
grep -r "ATTR_EMULATE_PREPARES.*false" /var/www/html/crud-rh/config/
```

---

## Résumé

| Aspect | AVANT — Vulnérable | APRÈS — Sécurisé |
|--------|-------------------|------------------|
| Connexion | mysqli + concaténation | PDO + requêtes préparées |
| Paramètres | Concaténation directe | `bindParam()` ou `execute([$val])` |
| LIKE | `LIKE '%$search%'` | Échappement + `LIKE :search` |
| Émulation | `EMULATE_PREPARES = true` | `EMULATE_PREPARES = false` |
| Validation | Aucune | `filter_var()`, regex, typage strict |

---

## Références

- OWASP Top 10 2021 — A03:2021 Injection
- OWASP SQL Injection Prevention Cheat Sheet
- CWE-89 : SQL Injection — CVSS 9.8/10 (CRITICAL)
- PHP Documentation : PDO Prepared Statements

:::tip Prochaine Section
La section **15.3 Cross-Site Scripting (XSS)** abordera les techniques d'échappement de sortie et l'implémentation de Content Security Policy (CSP).
:::