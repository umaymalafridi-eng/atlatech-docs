---
id: secure-logging
title: Logging Sécurisé
sidebar_label: "15.9 Logging Sécurisé"
sidebar_position: 9
---

# 15.9 Logging Sécurisé

## Importance du Logging

Le logging (journalisation) est essentiel pour :
- **Audit de sécurité** : Qui a fait quoi et quand ?
- **Détection d'incidents** : Identifier les tentatives d'attaque
- **Investigation** : Analyser les incidents a posteriori
- **Conformité** : Répondre aux exigences RGPD, ISO 27001
- **Debug** : Résoudre les problèmes applicatifs

:::danger Règles de Sécurité
- **NE JAMAIS** logger les mots de passe
- **NE JAMAIS** logger les tokens de session complets
- **NE JAMAIS** logger les numéros de carte bancaire
- **MASQUER** les données personnelles sensibles
:::

---

## Configuration du Logging

### 15.9.1 Table audit_logs

```sql
CREATE TABLE audit_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    timestamp DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    user_id INT NULL,
    username VARCHAR(100) NULL,
    session_id VARCHAR(255) NULL,
    ip_address VARCHAR(45) NOT NULL,
    user_agent_hash CHAR(64) NULL,
    action VARCHAR(50) NOT NULL,
    entity_type VARCHAR(50) NULL,
    entity_id INT NULL,
    old_values TEXT NULL,
    new_values TEXT NULL,
    changes_summary TEXT NULL,
    severity ENUM('info', 'warning', 'critical') DEFAULT 'info',
    metadata JSON NULL,
    INDEX idx_timestamp (timestamp),
    INDEX idx_user_action (user_id, action),
    INDEX idx_entity (entity_type, entity_id),
    INDEX idx_severity (severity, timestamp)
) ENGINE=InnoDB;
```

### 15.9.2 Classe de Logging

```php
<?php
/**
 * Classe de logging sécurisé
 */
class AuditLogger {
    
    private $pdo;
    
    // Champs sensibles à masquer dans les logs
    private const SENSITIVE_FIELDS = [
        'password',
        'password_hash',
        'password_confirm',
        'csrf_token',
        'session_id',
        'credit_card',
        'cvv',
        'pin'
    ];
    
    public function __construct($pdo) {
        $this->pdo = $pdo;
    }
    
    /**
     * Log une action utilisateur
     */
    public function log($action, $entity_type = null, $entity_id = null, $old_values = null, $new_values = null, $severity = 'info') {
        
        // Masquer les données sensibles
        $old_values_safe = $this->maskSensitiveData($old_values);
        $new_values_safe = $this->maskSensitiveData($new_values);
        
        // Générer un résumé des changements
        $changes_summary = $this->generateChangesSummary($old_values_safe, $new_values_safe);
        
        // Préparer les métadonnées
        $metadata = [
            'request_uri' => $_SERVER['REQUEST_URI'] ?? null,
            'http_method' => $_SERVER['REQUEST_METHOD'] ?? null,
            'referer' => $_SERVER['HTTP_REFERER'] ?? null
        ];
        
        $sql = "INSERT INTO audit_logs (
                    user_id,
                    username,
                    session_id,
                    ip_address,
                    user_agent_hash,
                    action,
                    entity_type,
                    entity_id,
                    old_values,
                    new_values,
                    changes_summary,
                    severity,
                    metadata
                ) VALUES (
                    :user_id,
                    :username,
                    :session_id,
                    :ip_address,
                    :user_agent_hash,
                    :action,
                    :entity_type,
                    :entity_id,
                    :old_values,
                    :new_values,
                    :changes_summary,
                    :severity,
                    :metadata
                )";
        
        $stmt = $this->pdo->prepare($sql);
        $stmt->execute([
            ':user_id' => $_SESSION['user_id'] ?? null,
            ':username' => $_SESSION['username'] ?? null,
            ':session_id' => $this->hashSessionId(session_id()),
            ':ip_address' => $this->getClientIP(),
            ':user_agent_hash' => hash('sha256', $_SERVER['HTTP_USER_AGENT'] ?? ''),
            ':action' => $action,
            ':entity_type' => $entity_type,
            ':entity_id' => $entity_id,
            ':old_values' => $old_values_safe ? json_encode($old_values_safe) : null,
            ':new_values' => $new_values_safe ? json_encode($new_values_safe) : null,
            ':changes_summary' => $changes_summary,
            ':severity' => $severity,
            ':metadata' => json_encode($metadata)
        ]);
    }
    
    /**
     * Masquer les données sensibles
     */
    private function maskSensitiveData($data) {
        if (!is_array($data)) {
            return $data;
        }
        
        $masked = [];
        
        foreach ($data as $key => $value) {
            if (in_array(strtolower($key), self::SENSITIVE_FIELDS)) {
                $masked[$key] = '***MASKED***';
            } else {
                $masked[$key] = $value;
            }
        }
        
        return $masked;
    }
    
    /**
     * Générer un résumé textuel des changements
     */
    private function generateChangesSummary($old, $new) {
        if (!$old || !$new) {
            return null;
        }
        
        $changes = [];
        
        foreach ($new as $key => $new_value) {
            if (isset($old[$key]) && $old[$key] != $new_value) {
                $changes[] = "$key: '{$old[$key]}' → '$new_value'";
            }
        }
        
        return implode(', ', $changes);
    }
    
    /**
     * Hasher l'ID de session (ne pas stocker en clair)
     */
    private function hashSessionId($session_id) {
        return substr(hash('sha256', $session_id), 0, 16);
    }
    
    /**
     * Récupérer l'IP réelle du client (derrière proxy)
     */
    private function getClientIP() {
        $ip_keys = ['HTTP_X_FORWARDED_FOR', 'HTTP_CLIENT_IP', 'REMOTE_ADDR'];
        
        foreach ($ip_keys as $key) {
            if (isset($_SERVER[$key])) {
                $ip = $_SERVER[$key];
                
                // Si plusieurs IPs (proxy), prendre la première
                if (strpos($ip, ',') !== false) {
                    $ip = trim(explode(',', $ip)[0]);
                }
                
                // Valider l'IP
                if (filter_var($ip, FILTER_VALIDATE_IP)) {
                    return $ip;
                }
            }
        }
        
        return '0.0.0.0';
    }
}
?>
```

---

## Logging des Actions CRUD

### 15.9.3 Exemples d'Utilisation

```php
<?php
require_once 'includes/audit-logger.php';

$logger = new AuditLogger($pdo);

// 1. LOG DE CONNEXION
if ($login_success) {
    $logger->log('login', null, null, null, null, 'info');
}

// 2. LOG DE CRÉATION D'EMPLOYÉ
$new_employee = [
    'prenom' => 'Ahmed',
    'nom' => 'Alami',
    'email' => 'ahmed@test.com',
    'salaire_mensuel' => 5000.00
];

$logger->log('create', 'employe', $employee_id, null, $new_employee, 'info');

// 3. LOG DE MODIFICATION D'EMPLOYÉ
$old_data = [
    'prenom' => 'Ahmed',
    'salaire_mensuel' => 5000.00
];

$new_data = [
    'prenom' => 'Ahmed',
    'salaire_mensuel' => 6000.00
];

$logger->log('update', 'employe', $employee_id, $old_data, $new_data, 'info');

// 4. LOG DE SUPPRESSION
$deleted_employee = [
    'id' => 5,
    'prenom' => 'Test',
    'nom' => 'User'
];

$logger->log('delete', 'employe', 5, $deleted_employee, null, 'warning');

// 5. LOG DE TENTATIVE D'ACCÈS NON AUTORISÉ (IDOR)
$logger->log('unauthorized_access_attempt', 'employe', $requested_id, null, null, 'critical');

// 6. LOG DE TENTATIVE CSRF
$logger->log('csrf_attack_detected', null, null, null, null, 'critical');
?>
```

---

## Rotation des Logs

### 15.9.4 Archivage Mensuel

```sql
-- Créer une table d'archive
CREATE TABLE audit_logs_archive_2024_01 LIKE audit_logs;

-- Déplacer les logs du mois précédent
INSERT INTO audit_logs_archive_2024_01
SELECT * FROM audit_logs
WHERE timestamp >= '2024-01-01' AND timestamp < '2024-02-01';

-- Supprimer les logs archivés de la table principale
DELETE FROM audit_logs
WHERE timestamp >= '2024-01-01' AND timestamp < '2024-02-01';

-- Optimiser la table
OPTIMIZE TABLE audit_logs;
```

### 15.9.5 Script de Rotation Automatique

```bash
#!/bin/bash
# /usr/local/bin/rotate-audit-logs.sh

# Variables
DB_HOST="192.168.30.10"
DB_NAME="atlastech_rh"
DB_USER="root"
DB_PASS="password"

# Mois précédent
LAST_MONTH=$(date -d "last month" +%Y_%m)
FIRST_DAY=$(date -d "last month" +%Y-%m-01)
LAST_DAY=$(date +%Y-%m-01)

# Nom de la table d'archive
ARCHIVE_TABLE="audit_logs_archive_${LAST_MONTH}"

echo "Rotation des logs : $ARCHIVE_TABLE"

# Créer la table d'archive
mysql -h $DB_HOST -u $DB_USER -p$DB_PASS $DB_NAME << EOF
CREATE TABLE IF NOT EXISTS $ARCHIVE_TABLE LIKE audit_logs;

INSERT INTO $ARCHIVE_TABLE
SELECT * FROM audit_logs
WHERE timestamp >= '$FIRST_DAY' AND timestamp < '$LAST_DAY';

DELETE FROM audit_logs
WHERE timestamp >= '$FIRST_DAY' AND timestamp < '$LAST_DAY';

OPTIMIZE TABLE audit_logs;
EOF

echo "Rotation terminée : $(mysql -h $DB_HOST -u $DB_USER -p$DB_PASS $DB_NAME -e "SELECT COUNT(*) FROM $ARCHIVE_TABLE;" -s) logs archivés"

# Cron : Exécuter le 1er de chaque mois à 2h
# 0 2 1 * * /usr/local/bin/rotate-audit-logs.sh >> /var/log/audit-rotation.log 2>&1
```

---

## Centralisation SIEM

### 15.9.6 Export vers Système SIEM

```php
<?php
/**
 * Export des logs vers un SIEM (ELK Stack, Splunk, etc.)
 */
class SIEMExporter {
    
    /**
     * Envoyer un log à Elasticsearch
     */
    public static function sendToElasticsearch($log_data) {
        $elasticsearch_url = 'http://192.168.30.20:9200/atlastech-audit/_doc';
        
        $ch = curl_init($elasticsearch_url);
        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($log_data));
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_HTTPHEADER, [
            'Content-Type: application/json',
        ]);
        
        $result = curl_exec($ch);
        curl_close($ch);
        
        return $result;
    }
    
    /**
     * Envoyer un log à Syslog
     */
    public static function sendToSyslog($message, $priority = LOG_INFO) {
        openlog('atlastech-rh', LOG_PID | LOG_PERROR, LOG_USER);
        syslog($priority, $message);
        closelog();
    }
}
?>
```

---

## Consultation des Logs

### 15.9.7 Interface de Consultation

```php
<?php
// /admin/audit-logs.php
session_start();

if ($_SESSION['role'] !== 'admin') {
    die("Accès réservé aux administrateurs");
}

require_once '../config/database.php';

// Filtres
$user_id = $_GET['user_id'] ?? null;
$action = $_GET['action'] ?? null;
$severity = $_GET['severity'] ?? null;
$date_from = $_GET['date_from'] ?? date('Y-m-d', strtotime('-7 days'));
$date_to = $_GET['date_to'] ?? date('Y-m-d');

// Construction de la requête
$sql = "SELECT * FROM audit_logs WHERE 1=1";
$params = [];

if ($user_id) {
    $sql .= " AND user_id = :user_id";
    $params[':user_id'] = $user_id;
}

if ($action) {
    $sql .= " AND action = :action";
    $params[':action'] = $action;
}

if ($severity) {
    $sql .= " AND severity = :severity";
    $params[':severity'] = $severity;
}

$sql .= " AND timestamp >= :date_from AND timestamp <= :date_to";
$params[':date_from'] = $date_from . ' 00:00:00';
$params[':date_to'] = $date_to . ' 23:59:59';

$sql .= " ORDER BY timestamp DESC LIMIT 1000";

$stmt = $pdo->prepare($sql);
$stmt->execute($params);
$logs = $stmt->fetchAll();
?>

<!DOCTYPE html>
<html>
<head>
    <title>Logs d'Audit</title>
    <style>
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .critical { background-color: #ffcccc; }
        .warning { background-color: #fff3cd; }
    </style>
</head>
<body>
    <h1>Logs d'Audit</h1>
    
    <!-- Filtres -->
    <form method="GET">
        <label>Utilisateur : <input type="number" name="user_id" value="<?= htmlspecialchars($user_id) ?>"></label>
        <label>Action : <input type="text" name="action" value="<?= htmlspecialchars($action) ?>"></label>
        <label>Sévérité :
            <select name="severity">
                <option value="">Tous</option>
                <option value="info" <?= $severity === 'info' ? 'selected' : '' ?>>Info</option>
                <option value="warning" <?= $severity === 'warning' ? 'selected' : '' ?>>Warning</option>
                <option value="critical" <?= $severity === 'critical' ? 'selected' : '' ?>>Critical</option>
            </select>
        </label>
        <label>Du : <input type="date" name="date_from" value="<?= htmlspecialchars($date_from) ?>"></label>
        <label>Au : <input type="date" name="date_to" value="<?= htmlspecialchars($date_to) ?>"></label>
        <button type="submit">Filtrer</button>
    </form>
    
    <p><?= count($logs) ?> résultat(s)</p>
    
    <table>
        <thead>
            <tr>
                <th>Date/Heure</th>
                <th>Utilisateur</th>
                <th>IP</th>
                <th>Action</th>
                <th>Entité</th>
                <th>Changements</th>
                <th>Sévérité</th>
            </tr>
        </thead>
        <tbody>
            <?php foreach ($logs as $log): ?>
            <tr class="<?= $log['severity'] ?>">
                <td><?= htmlspecialchars($log['timestamp']) ?></td>
                <td><?= htmlspecialchars($log['username'] ?? 'N/A') ?></td>
                <td><?= htmlspecialchars($log['ip_address']) ?></td>
                <td><?= htmlspecialchars($log['action']) ?></td>
                <td><?= htmlspecialchars($log['entity_type'] ?? '') ?> #<?= htmlspecialchars($log['entity_id'] ?? '') ?></td>
                <td><?= htmlspecialchars($log['changes_summary'] ?? '-') ?></td>
                <td><?= htmlspecialchars($log['severity']) ?></td>
            </tr>
            <?php endforeach; ?>
        </tbody>
    </table>
</body>
</html>
```

---

## Résumé

### Checklist de Logging

- [ ] Ne JAMAIS logger les mots de passe
- [ ] Masquer les données sensibles
- [ ] Logger toutes les actions CRUD
- [ ] Logger les tentatives d'attaque (CSRF, IDOR, SQL Injection)
- [ ] Logger les connexions/déconnexions
- [ ] Inclure IP, user agent (hashé), timestamp
- [ ] Rotation mensuelle des logs
- [ ] Exporter vers SIEM si disponible
- [ ] Interface de consultation pour admin
- [ ] Archivage long terme (conformité)

---

:::tip Prochaine Section
**15.10 Gestion des Erreurs** : Affichage sécurisé des erreurs en production.
:::