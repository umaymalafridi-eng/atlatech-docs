---
id: idor-protection
title: Protection IDOR
sidebar_label: "15.6 IDOR Protection"
sidebar_position: 6
---

# 15.6 Protection IDOR (Insecure Direct Object Reference)

## Introduction

L'IDOR est une vulnérabilité où un utilisateur peut accéder à des ressources (fichiers, données) en modifiant simplement un identifiant dans l'URL, sans vérification d'autorisation.

**Exemple :** `/employe.php?id=123` → Un utilisateur change `id=123` en `id=124` et accède aux données d'un autre employé.

:::danger Impact
- Accès non autorisé aux données sensibles
- Vol d'informations confidentielles (salaires, documents)
- Modification/suppression de ressources d'autres utilisateurs
:::

---

## Code Vulnérable (AVANT)

```php
<?php
// /employes/voir_detail.php (VULNÉRABLE)
$employe_id = $_GET['id'];

$sql = "SELECT * FROM employes WHERE id = :id";
$stmt = $pdo->prepare($sql);
$stmt->execute([':id' => $employe_id]);
$employe = $stmt->fetch();

// PROBLÈME : Aucune vérification que l'utilisateur a le droit de voir cet employé
echo "<h1>{$employe['prenom']} {$employe['nom']}</h1>";
echo "<p>Salaire : {$employe['salaire_mensuel']} MAD</p>";
?>
```

**Exploitation :**

```bash
# Utilisateur normal accède à son profil
https://rh-interne.atlastech.local/employes/voir_detail.php?id=15

# Utilisateur modifie l'ID pour voir d'autres employés
https://rh-interne.atlastech.local/employes/voir_detail.php?id=1  # Directeur
https://rh-interne.atlastech.local/employes/voir_detail.php?id=2  # Responsable RH
# Accès à TOUS les salaires de l'entreprise !
```

---

## Solution : Vérification d'Autorisation (APRÈS)

### 15.6.1 Middleware d'Autorisation

```php
<?php
/**
 * Vérifie si l'utilisateur a le droit d'accéder à une ressource
 */
class AccessControl {
    
    /**
     * Vérifie si l'utilisateur peut voir les détails d'un employé
     */
    public static function canViewEmploye($employe_id, $user_id, $user_role) {
        // Admin et RH peuvent voir tous les employés
        if (in_array($user_role, ['admin', 'rh'])) {
            return true;
        }
        
        // Un employé peut voir uniquement son propre profil
        return ($employe_id == $user_id);
    }
    
    /**
     * Vérifie si l'utilisateur peut modifier un employé
     */
    public static function canEditEmploye($employe_id, $user_role) {
        // Seuls admin et RH peuvent modifier
        return in_array($user_role, ['admin', 'rh']);
    }
    
    /**
     * Vérifie si l'utilisateur peut supprimer un employé
     */
    public static function canDeleteEmploye($user_role) {
        // Seul l'admin peut supprimer
        return ($user_role === 'admin');
    }
}
?>
```

### 15.6.2 Application de l'Autorisation

```php
<?php
// /employes/voir_detail.php (SÉCURISÉ)
session_start();
require_once '../includes/access-control.php';

$employe_id = $_GET['id'] ?? null;

if (!filter_var($employe_id, FILTER_VALIDATE_INT)) {
    http_response_code(400);
    die("ID invalide");
}

// SOLUTION : Vérification d'autorisation
if (!AccessControl::canViewEmploye($employe_id, $_SESSION['user_id'], $_SESSION['role'])) {
    // Log de tentative d'accès non autorisé
    error_log("[IDOR Attempt] User {$_SESSION['user_id']} tried to access employe $employe_id");
    
    http_response_code(403);
    die("Accès interdit");
}

// Si autorisé, récupérer les données
$sql = "SELECT * FROM employes WHERE id = :id";
$stmt = $pdo->prepare($sql);
$stmt->execute([':id' => $employe_id]);
$employe = $stmt->fetch();

if (!$employe) {
    http_response_code(404);
    die("Employé introuvable");
}

// Affichage sécurisé
?>
<!DOCTYPE html>
<html>
<head><title>Détails Employé</title></head>
<body>
    <h1><?= htmlspecialchars($employe['prenom'] . ' ' . $employe['nom']) ?></h1>
    
    <?php if (in_array($_SESSION['role'], ['admin', 'rh'])): ?>
        <p>Salaire : <?= number_format($employe['salaire_mensuel'], 2) ?> MAD</p>
    <?php endif; ?>
</body>
</html>
```

**Test d'accès non autorisé :**

```bash
# Employé ID=15 tente d'accéder à l'employé ID=1
curl -b "PHPSESSID=session_user15" \
  https://rh-interne.atlastech.local/employes/voir_detail.php?id=1

# Résultat :
HTTP/1.1 403 Forbidden
Accès interdit

# Log généré :
[IDOR Attempt] User 15 tried to access employe 1
```

---

## Utilisation d'UUID au Lieu d'ID Séquentiels

### 15.6.3 Avantage des UUID

Les ID séquentiels (1, 2, 3...) facilitent l'énumération. Les UUID sont imprévisibles.

```sql
-- Migration vers UUID
ALTER TABLE employes ADD COLUMN uuid CHAR(36) UNIQUE;

-- Génération des UUID pour les données existantes
UPDATE employes SET uuid = UUID();

-- Exemple de résultat :
-- ID: 1 → UUID: 550e8400-e29b-41d4-a716-446655440000
-- ID: 2 → UUID: 6ba7b810-9dad-11d1-80b4-00c04fd430c8
```

**URL avec UUID :**

```
Avant : /employe.php?id=1
Après : /employe.php?uuid=550e8400-e29b-41d4-a716-446655440000

Impossible de deviner l'UUID d'un autre employé
```

---

:::tip Prochaine Section
La section **15.7 Upload Sécurisé** abordera la validation des fichiers uploadés.
:::