---
id: error-handling
title: Gestion des Erreurs
sidebar_label: "15.10 Gestion des Erreurs"
sidebar_position: 10
---

# 15.10 Gestion des Erreurs

## Principe de Sécurité

Les messages d'erreur détaillés exposent des informations sensibles sur l'infrastructure :
- Chemins de fichiers complets
- Versions de logiciels (PHP, MySQL)
- Structure de la base de données
- Stack traces révélant l'architecture

:::danger Règle d'Or
**EN PRODUCTION :** Afficher des messages génériques à l'utilisateur, logger les détails côté serveur.
**EN DÉVELOPPEMENT :** Afficher les erreurs détaillées pour le debugging.
:::

---

## Configuration PHP Production vs Développement

### 15.10.1 php.ini Production

```ini
# /etc/php/8.1/apache2/php.ini (PRODUCTION)

# NE PAS afficher les erreurs au navigateur
display_errors = Off
display_startup_errors = Off

# Logger les erreurs dans un fichier
log_errors = On
error_log = /var/log/php/error.log

# Niveau de rapport d'erreur
error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT

# Masquer la version de PHP dans les headers HTTP
expose_php = Off
```

### 15.10.2 php.ini Développement

```ini
# /etc/php/8.1/apache2/php.ini (DÉVELOPPEMENT)

# Afficher les erreurs pour le debugging
display_errors = On
display_startup_errors = On

# Logger aussi dans un fichier
log_errors = On
error_log = /var/log/php/error.log

# Tout reporter
error_reporting = E_ALL

# Peut exposer PHP (développement local uniquement)
expose_php = On
```

**Application de la configuration :**

```bash
# Redémarrer Apache après modification
sudo systemctl restart apache2

# Vérifier la configuration active
php -i | grep display_errors
# Production : display_errors => Off
# Développement : display_errors => On
```

---

## Gestion des Erreurs en Code

### 15.10.3 Handler d'Erreurs Personnalisé

```php
<?php
/**
 * Gestionnaire d'erreurs personnalisé
 */

// Déterminer l'environnement
define('ENVIRONMENT', getenv('APP_ENV') ?: 'production');

/**
 * Handler d'erreur personnalisé
 */
set_error_handler(function($errno, $errstr, $errfile, $errline) {
    
    // Logger l'erreur
    $error_message = "[$errno] $errstr in $errfile on line $errline";
    error_log($error_message);
    
    // En production, afficher un message générique
    if (ENVIRONMENT === 'production') {
        // Ne pas révéler de détails
        echo "<h1>Une erreur est survenue</h1>";
        echo "<p>Veuillez réessayer ultérieurement. Si le problème persiste, contactez le support.</p>";
        exit;
    } else {
        // En développement, afficher les détails
        echo "<h1>Erreur PHP</h1>";
        echo "<p><strong>Erreur :</strong> $errstr</p>";
        echo "<p><strong>Fichier :</strong> $errfile</p>";
        echo "<p><strong>Ligne :</strong> $errline</p>";
        exit;
    }
});

/**
 * Handler d'exception personnalisé
 */
set_exception_handler(function($exception) {
    
    // Logger l'exception
    error_log("Exception: " . $exception->getMessage() . " in " . $exception->getFile() . " on line " . $exception->getLine());
    error_log("Stack trace: " . $exception->getTraceAsString());
    
    // En production, message générique
    if (ENVIRONMENT === 'production') {
        http_response_code(500);
        echo "<h1>Erreur interne du serveur</h1>";
        echo "<p>Une erreur s'est produite. Veuillez réessayer plus tard.</p>";
    } else {
        // En développement, afficher l'exception
        http_response_code(500);
        echo "<h1>Exception Non Capturée</h1>";
        echo "<p><strong>Message :</strong> " . htmlspecialchars($exception->getMessage()) . "</p>";
        echo "<p><strong>Fichier :</strong> " . htmlspecialchars($exception->getFile()) . "</p>";
        echo "<p><strong>Ligne :</strong> " . $exception->getLine() . "</p>";
        echo "<pre>" . htmlspecialchars($exception->getTraceAsString()) . "</pre>";
    }
});
?>
```

### 15.10.4 Gestion des Erreurs PDO

```php
<?php
/**
 * Gestion sécurisée des erreurs PDO
 */

try {
    $pdo = new PDO($dsn, $user, $pass, [
        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION
    ]);
    
    $stmt = $pdo->prepare("SELECT * FROM employes WHERE id = :id");
    $stmt->execute([':id' => $employe_id]);
    
} catch (PDOException $e) {
    
    // LOGGER l'erreur détaillée (JAMAIS afficher à l'utilisateur)
    error_log("Erreur PDO : " . $e->getMessage());
    error_log("Query : " . ($stmt->queryString ?? 'N/A'));
    error_log("Trace : " . $e->getTraceAsString());
    
    // AFFICHER un message générique en production
    if (ENVIRONMENT === 'production') {
        die("Une erreur de base de données est survenue. Veuillez contacter le support.");
    } else {
        // En développement, afficher les détails
        die("Erreur PDO : " . $e->getMessage());
    }
}
?>
```

---

## Pages d'Erreur Personnalisées

### 15.10.5 Configuration Apache

```apache
# /etc/apache2/sites-enabled/crud-rh.conf

<VirtualHost 192.168.20.10:443>
    ServerName rh-interne.atlastech.local
    DocumentRoot /var/www/html/crud-rh

    # Pages d'erreur personnalisées
    ErrorDocument 400 /errors/400.php
    ErrorDocument 401 /errors/401.php
    ErrorDocument 403 /errors/403.php
    ErrorDocument 404 /errors/404.php
    ErrorDocument 500 /errors/500.php
    ErrorDocument 503 /errors/503.php

    # Désactiver les signatures Apache (masquer la version)
    ServerSignature Off
    ServerTokens Prod
    
    # ... reste de la configuration
</VirtualHost>
```

### 15.10.6 Page 404 Personnalisée

```php
<?php
// /var/www/html/crud-rh/errors/404.php
http_response_code(404);
?>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page Non Trouvée - AtlasTech RH</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .error-container {
            text-align: center;
            background: white;
            padding: 50px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #d9534f;
            font-size: 72px;
            margin: 0;
        }
        p {
            color: #666;
            font-size: 18px;
        }
        a {
            color: #0275d8;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="error-container">
        <h1>404</h1>
        <h2>Page Non Trouvée</h2>
        <p>La page que vous recherchez n'existe pas ou a été déplacée.</p>
        <p><a href="/employes/liste.php">Retour à la liste des employés</a></p>
    </div>
</body>
</html>
```

### 15.10.7 Page 403 Personnalisée

```php
<?php
// /var/www/html/crud-rh/errors/403.php
http_response_code(403);
?>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Accès Interdit - AtlasTech RH</title>
</head>
<body>
    <div class="error-container">
        <h1>403</h1>
        <h2>Accès Interdit</h2>
        <p>Vous n'avez pas les permissions nécessaires pour accéder à cette ressource.</p>
        <p>Si vous pensez qu'il s'agit d'une erreur, veuillez contacter l'administrateur système.</p>
        <p><a href="/employes/liste.php">Retour</a></p>
    </div>
</body>
</html>
```

### 15.10.8 Page 500 Personnalisée

```php
<?php
// /var/www/html/crud-rh/errors/500.php
http_response_code(500);
?>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Erreur Serveur - AtlasTech RH</title>
</head>
<body>
    <div class="error-container">
        <h1>500</h1>
        <h2>Erreur Interne du Serveur</h2>
        <p>Une erreur inattendue s'est produite.</p>
        <p>Nos équipes techniques ont été notifiées et travaillent à résoudre le problème.</p>
        <p>Veuillez réessayer dans quelques instants.</p>
        <p><a href="/employes/liste.php">Retour</a></p>
    </div>
</body>
</html>
```

---

## Logging des Erreurs

### 15.10.9 Fichier de Log Structuré

```bash
# Créer le répertoire de logs
sudo mkdir -p /var/log/php
sudo chown www-data:www-data /var/log/php
sudo chmod 755 /var/log/php

# Créer le fichier de log
sudo touch /var/log/php/error.log
sudo chown www-data:www-data /var/log/php/error.log
sudo chmod 644 /var/log/php/error.log
```

### 15.10.10 Rotation des Logs d'Erreur

```bash
# /etc/logrotate.d/php-errors

/var/log/php/error.log {
    daily
    rotate 30
    missingok
    notifempty
    compress
    delaycompress
    create 0644 www-data www-data
    sharedscripts
    postrotate
        /usr/sbin/service apache2 reload > /dev/null 2>&1 || true
    endscript
}
```

---

## Monitoring des Erreurs

### 15.10.11 Script de Monitoring

```bash
#!/bin/bash
# /usr/local/bin/monitor-php-errors.sh

# Surveiller les erreurs critiques et envoyer des alertes

ERROR_LOG="/var/log/php/error.log"
ALERT_EMAIL="admin@atlastech.ma"
TEMP_FILE="/tmp/php_errors_check"

# Chercher les erreurs dans les dernières 5 minutes
find $ERROR_LOG -mmin -5 -type f > /dev/null 2>&1

if [ $? -eq 0 ]; then
    # Extraire les erreurs critiques
    grep -i "fatal\|critical\|exception" $ERROR_LOG | tail -20 > $TEMP_FILE
    
    if [ -s $TEMP_FILE ]; then
        # Envoyer une alerte email
        mail -s "ALERTE: Erreurs PHP critiques détectées" $ALERT_EMAIL < $TEMP_FILE
        
        # Logger dans syslog
        logger -t php-monitor "Erreurs PHP critiques détectées, email envoyé à $ALERT_EMAIL"
    fi
fi

rm -f $TEMP_FILE

# Cron : Exécuter toutes les 5 minutes
# */5 * * * * /usr/local/bin/monitor-php-errors.sh
```

---

## Gestion des Erreurs AJAX

### 15.10.12 Réponses JSON Sécurisées

```php
<?php
/**
 * API endpoint avec gestion d'erreur sécurisée
 */

header('Content-Type: application/json');

try {
    // Logique de l'API
    $data = getEmployeeData($id);
    
    // Succès
    http_response_code(200);
    echo json_encode([
        'success' => true,
        'data' => $data
    ]);
    
} catch (Exception $e) {
    
    // Logger l'erreur détaillée
    error_log("API Error : " . $e->getMessage());
    error_log("Trace : " . $e->getTraceAsString());
    
    // Réponse générique en production
    if (ENVIRONMENT === 'production') {
        http_response_code(500);
        echo json_encode([
            'success' => false,
            'error' => 'Une erreur est survenue',
            'error_code' => 'INTERNAL_ERROR'
        ]);
    } else {
        // Développement : inclure les détails
        http_response_code(500);
        echo json_encode([
            'success' => false,
            'error' => $e->getMessage(),
            'file' => $e->getFile(),
            'line' => $e->getLine(),
            'trace' => $e->getTraceAsString()
        ]);
    }
}
?>
```

---

## Codes d'Erreur Personnalisés

### 15.10.13 Système de Codes d'Erreur

```php
<?php
/**
 * Classe de codes d'erreur application
 */
class ErrorCodes {
    
    const DB_CONNECTION_FAILED = 'ERR_DB_001';
    const DB_QUERY_FAILED = 'ERR_DB_002';
    const INVALID_INPUT = 'ERR_INPUT_001';
    const UNAUTHORIZED = 'ERR_AUTH_001';
    const FORBIDDEN = 'ERR_AUTH_002';
    const RESOURCE_NOT_FOUND = 'ERR_RES_001';
    const CSRF_TOKEN_INVALID = 'ERR_SEC_001';
    const FILE_UPLOAD_FAILED = 'ERR_FILE_001';
    
    /**
     * Messages utilisateur associés
     */
    private static $messages = [
        self::DB_CONNECTION_FAILED => "Impossible de se connecter à la base de données",
        self::DB_QUERY_FAILED => "Erreur lors de l'exécution de la requête",
        self::INVALID_INPUT => "Les données fournies sont invalides",
        self::UNAUTHORIZED => "Veuillez vous connecter",
        self::FORBIDDEN => "Vous n'avez pas accès à cette ressource",
        self::RESOURCE_NOT_FOUND => "Ressource introuvable",
        self::CSRF_TOKEN_INVALID => "Token de sécurité invalide",
        self::FILE_UPLOAD_FAILED => "Erreur lors de l'upload du fichier"
    ];
    
    /**
     * Obtenir le message utilisateur pour un code
     */
    public static function getMessage($code) {
        return self::$messages[$code] ?? "Une erreur inconnue est survenue";
    }
}

// Utilisation
try {
    // Opération de base de données
} catch (PDOException $e) {
    error_log("DB Error: " . $e->getMessage());
    
    $error_code = ErrorCodes::DB_QUERY_FAILED;
    $user_message = ErrorCodes::getMessage($error_code);
    
    http_response_code(500);
    echo json_encode([
        'success' => false,
        'error' => $user_message,
        'error_code' => $error_code
    ]);
}
?>
```

---

## Tests

### 15.10.14 Test de Gestion d'Erreur

```bash
#!/bin/bash
# Script de test de gestion d'erreur

echo "=== Tests Gestion des Erreurs ==="

# 1. Test erreur 404
echo "[1] Test 404 (page inexistante)..."
RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://rh-interne.atlastech.local/page_inexistante.php)

if [ "$RESPONSE" -eq 404 ]; then
    echo "✓ 404 correctement géré"
else
    echo "✗ Problème 404 (Code: $RESPONSE)"
fi

# 2. Vérifier absence de stack trace
echo "[2] Test absence de stack trace en production..."
PAGE_CONTENT=$(curl -s https://rh-interne.atlastech.local/test_error.php)

if echo "$PAGE_CONTENT" | grep -q "Stack trace"; then
    echo "✗ VULNÉRABILITÉ : Stack trace exposé"
else
    echo "✓ Stack trace masqué"
fi

# 3. Vérifier ServerTokens
echo "[3] Test masquage version Apache..."
SERVER_HEADER=$(curl -s -I https://rh-interne.atlastech.local/ | grep "^Server:")

if echo "$SERVER_HEADER" | grep -qE "Apache/[0-9]+\.[0-9]+"; then
    echo "✗ Version Apache exposée : $SERVER_HEADER"
else
    echo "✓ Version Apache masquée : $SERVER_HEADER"
fi

# 4. Vérifier expose_php
echo "[4] Test masquage version PHP..."
PHP_HEADER=$(curl -s -I https://rh-interne.atlastech.local/ | grep "^X-Powered-By:")

if [ -z "$PHP_HEADER" ]; then
    echo "✓ Header X-Powered-By absent (PHP masqué)"
else
    echo "✗ Version PHP exposée : $PHP_HEADER"
fi

echo "=== Tests terminés ==="
```

---

## Résumé

### Checklist Gestion des Erreurs

- [ ] `display_errors = Off` en production
- [ ] `log_errors = On` toujours
- [ ] Handlers d'erreur personnalisés
- [ ] Pages d'erreur personnalisées (404, 403, 500)
- [ ] Messages génériques en production
- [ ] Logging détaillé côté serveur
- [ ] Masquage des versions (expose_php, ServerTokens)
- [ ] Rotation des logs d'erreur
- [ ] Monitoring et alertes
- [ ] Codes d'erreur application

---

## Conclusion de la Section 15

Nous avons couvert les **10 aspects critiques de la sécurité applicative** :

1. Architecture Application
2. SQL Injection Prevention
3. XSS Protection
4. CSRF Protection
5. Mass Assignment Protection
6. IDOR Protection
7. Secure File Upload
8. Input Validation
9. Secure Logging
10. Error Handling

**Principes Transversaux :**
- Defense in Depth (plusieurs couches de sécurité)
- Principle of Least Privilege (moindre privilège)
- Never Trust User Input (ne jamais faire confiance aux entrées)
- Fail Securely (échouer de manière sécurisée)

**Conformité :**
- OWASP Top 10 2021
- ISO/IEC 27001
- RGPD
- CIS Controls

