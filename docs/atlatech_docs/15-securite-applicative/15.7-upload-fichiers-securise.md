---
id: secure-file-upload
title: Upload de Fichiers Sécurisé
sidebar_label: "15.7 Upload Sécurisé"
sidebar_position: 7
---

# 15.7 Upload de Fichiers Sécurisé

## Introduction

L'upload de fichiers est l'une des fonctionnalités les plus dangereuses si mal sécurisée. Un attaquant peut uploader du code malveillant et l'exécuter sur le serveur.

:::danger Risques
- Exécution de code arbitraire (RCE)
- Installation de webshell/backdoor
- Déni de service (fichiers volumineux)
- Stockage de malware
- Attaques XSS via fichiers SVG/HTML
:::

---

## Code Vulnérable (AVANT)

```php
<?php
// /employes/upload_photo.php (VULNÉRABLE)

if ($_FILES['photo']['error'] === UPLOAD_ERR_OK) {
    $filename = $_FILES['photo']['name'];
    $destination = "/var/www/html/uploads/" . $filename;
    
    // VULNÉRABILITÉ : Aucune validation !
    move_uploaded_file($_FILES['photo']['tmp_name'], $destination);
    
    echo "Photo uploadée : $filename";
}
?>

<form method="POST" enctype="multipart/form-data">
    <input type="file" name="photo">
    <button type="submit">Upload</button>
</form>
```

**Exploitation - Upload de Webshell :**

```bash
# Attaquant crée un fichier PHP malveillant
cat > webshell.php << 'EOF'
<?php system($_GET['cmd']); ?>
EOF

# Upload du fichier
curl -F "photo=@webshell.php" \
  https://rh-interne.atlastech.local/employes/upload_photo.php

# Accès au webshell
curl "https://rh-interne.atlastech.local/uploads/webshell.php?cmd=whoami"
# Résultat : www-data (l'attaquant peut exécuter n'importe quelle commande !)
```

---

## Solution : Validation Multi-Couches (APRÈS)

### 15.7.1 Configuration PHP Sécurisée

```ini
# /etc/php/8.1/apache2/php.ini

file_uploads = On
upload_max_filesize = 5M         ; Limite à 5 Mo
max_file_uploads = 3             ; Maximum 3 fichiers simultanés
post_max_size = 6M              ; Légèrement > upload_max_filesize
```

### 15.7.2 Upload Sécurisé Complet

```php
<?php
/**
 * Classe pour upload sécurisé de photos d'employés
 */
class SecureFileUpload {
    
    // WHITELIST stricte des extensions autorisées
    private const ALLOWED_EXTENSIONS = ['jpg', 'jpeg', 'png', 'gif'];
    
    // WHITELIST des types MIME autorisés
    private const ALLOWED_MIME_TYPES = [
        'image/jpeg',
        'image/png',
        'image/gif'
    ];
    
    // Taille maximale en bytes (5 Mo)
    private const MAX_FILE_SIZE = 5 * 1024 * 1024;
    
    // Répertoire de destination (HORS webroot)
    private const UPLOAD_DIR = '/var/atlastech/uploads/photos/';
    
    /**
     * Valide et upload un fichier
     */
    public static function uploadPhoto($file, $employe_id) {
        // 1. Vérifier les erreurs PHP
        if ($file['error'] !== UPLOAD_ERR_OK) {
            throw new Exception(self::getUploadErrorMessage($file['error']));
        }
        
        // 2. Vérifier la taille du fichier
        if ($file['size'] > self::MAX_FILE_SIZE) {
            throw new Exception("Fichier trop volumineux (max 5 Mo)");
        }
        
        // 3. Vérifier l'extension (côté client, peut être contourné)
        $extension = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));
        if (!in_array($extension, self::ALLOWED_EXTENSIONS)) {
            throw new Exception("Extension non autorisée. Autorisées : " . implode(', ', self::ALLOWED_EXTENSIONS));
        }
        
        // 4. Vérifier le type MIME (côté serveur, CRITIQUE)
        $finfo = finfo_open(FILEINFO_MIME_TYPE);
        $mime_type = finfo_file($finfo, $file['tmp_name']);
        finfo_close($finfo);
        
        if (!in_array($mime_type, self::ALLOWED_MIME_TYPES)) {
            throw new Exception("Type de fichier non autorisé : $mime_type");
        }
        
        // 5. Vérifier les magic bytes (signature du fichier)
        if (!self::validateImageSignature($file['tmp_name'], $mime_type)) {
            throw new Exception("Fichier corrompu ou non valide");
        }
        
        // 6. Scanner antivirus (ClamAV)
        if (!self::scanWithClamAV($file['tmp_name'])) {
            throw new Exception("Fichier détecté comme malveillant");
        }
        
        // 7. Générer un nom de fichier aléatoire (UUID)
        $new_filename = bin2hex(random_bytes(16)) . '.' . $extension;
        $destination = self::UPLOAD_DIR . $new_filename;
        
        // 8. Créer le répertoire si inexistant (avec permissions sécurisées)
        if (!is_dir(self::UPLOAD_DIR)) {
            mkdir(self::UPLOAD_DIR, 0750, true);
        }
        
        // 9. Déplacer le fichier
        if (!move_uploaded_file($file['tmp_name'], $destination)) {
            throw new Exception("Erreur lors de l'upload");
        }
        
        // 10. Définir les permissions du fichier (lecture seule)
        chmod($destination, 0640);
        
        // 11. Mettre à jour la base de données
        global $pdo;
        $sql = "UPDATE employes SET photo_url = :photo WHERE id = :id";
        $stmt = $pdo->prepare($sql);
        $stmt->execute([
            ':photo' => $new_filename,
            ':id' => $employe_id
        ]);
        
        return $new_filename;
    }
    
    /**
     * Valide la signature du fichier (magic bytes)
     */
    private static function validateImageSignature($filepath, $expected_mime) {
        $file_handle = fopen($filepath, 'rb');
        $header = fread($file_handle, 12);
        fclose($file_handle);
        
        $signatures = [
            'image/jpeg' => [
                'FF D8 FF',                    // JPEG
            ],
            'image/png' => [
                '89 50 4E 47 0D 0A 1A 0A',     // PNG
            ],
            'image/gif' => [
                '47 49 46 38 37 61',           // GIF87a
                '47 49 46 38 39 61',           // GIF89a
            ]
        ];
        
        $header_hex = bin2hex($header);
        
        foreach ($signatures[$expected_mime] as $signature) {
            $signature_clean = str_replace(' ', '', $signature);
            if (strpos($header_hex, strtolower($signature_clean)) === 0) {
                return true;
            }
        }
        
        return false;
    }
    
    /**
     * Scanner antivirus avec ClamAV
     */
    private static function scanWithClamAV($filepath) {
        // Vérifier si ClamAV est installé
        if (!file_exists('/usr/bin/clamdscan')) {
            error_log("ClamAV non installé, scan ignoré");
            return true; // Ne pas bloquer si antivirus absent
        }
        
        // Scanner le fichier
        exec("/usr/bin/clamdscan --no-summary " . escapeshellarg($filepath), $output, $return_code);
        
        // Return code 0 = fichier propre, 1 = virus détecté
        return ($return_code === 0);
    }
    
    /**
     * Messages d'erreur upload PHP
     */
    private static function getUploadErrorMessage($error_code) {
        $errors = [
            UPLOAD_ERR_INI_SIZE => 'Fichier trop volumineux (limite serveur)',
            UPLOAD_ERR_FORM_SIZE => 'Fichier trop volumineux (limite formulaire)',
            UPLOAD_ERR_PARTIAL => 'Fichier partiellement uploadé',
            UPLOAD_ERR_NO_FILE => 'Aucun fichier uploadé',
            UPLOAD_ERR_NO_TMP_DIR => 'Répertoire temporaire manquant',
            UPLOAD_ERR_CANT_WRITE => 'Erreur d\'écriture sur le disque',
            UPLOAD_ERR_EXTENSION => 'Extension PHP a bloqué l\'upload',
        ];
        
        return $errors[$error_code] ?? 'Erreur inconnue';
    }
}
?>
```

### 15.7.3 Formulaire d'Upload

```php
<?php
session_start();
require_once '../includes/secure-upload.php';
require_once '../includes/csrf.php';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    
    CSRF::validateOrDie();
    
    $employe_id = $_POST['employe_id'];
    
    try {
        $filename = SecureFileUpload::uploadPhoto($_FILES['photo'], $employe_id);
        $_SESSION['success'] = "Photo uploadée avec succès";
        header("Location: /employes/voir_detail.php?id=$employe_id");
        exit;
        
    } catch (Exception $e) {
        $_SESSION['error'] = $e->getMessage();
    }
}
?>

<!DOCTYPE html>
<html>
<head><title>Upload Photo Employé</title></head>
<body>
    <h1>Uploader une photo</h1>
    
    <?php if (isset($_SESSION['error'])): ?>
        <div class="error"><?= htmlspecialchars($_SESSION['error']) ?></div>
        <?php unset($_SESSION['error']); ?>
    <?php endif; ?>
    
    <form method="POST" enctype="multipart/form-data">
        <?= CSRF::inputField() ?>
        
        <input type="hidden" name="employe_id" value="<?= htmlspecialchars($_GET['id']) ?>">
        
        <label>Photo de profil (JPG, PNG, GIF - Max 5 Mo) :</label>
        <input type="file" name="photo" accept="image/jpeg,image/png,image/gif" required>
        
        <button type="submit">Uploader</button>
    </form>
</body>
</html>
```

---

## Protection Apache

### 15.7.4 Désactiver l'Exécution de Scripts

```apache
# /etc/apache2/conf-available/disable-uploads-execution.conf

# Interdire l'exécution de PHP dans le répertoire uploads
<Directory /var/atlastech/uploads>
    Options -Indexes -ExecCGI
    AllowOverride None
    
    # Interdire tout type de script
    <FilesMatch "\.(php|php3|php4|php5|phtml|pl|py|cgi|sh)$">
        Require all denied
    </FilesMatch>
    
    # Forcer le téléchargement des fichiers (pas d'affichage inline)
    Header set Content-Disposition "attachment"
    
    # Désactiver les handlers PHP
    php_flag engine off
</Directory>
```

**Activation :**

```bash
sudo a2enconf disable-uploads-execution
sudo systemctl restart apache2
```

---

## Installation ClamAV

```bash
# Installation de l'antivirus ClamAV
sudo apt update
sudo apt install clamav clamav-daemon -y

# Mise à jour de la base de signatures
sudo freshclam

# Démarrage du service
sudo systemctl start clamav-daemon
sudo systemctl enable clamav-daemon

# Test de scan
clamdscan /tmp/test_file.jpg
```

---

## Résumé Sécurité Upload

| Couche | Protection |
|--------|------------|
| **Validation extension** | Whitelist (jpg, png, gif) |
| **Validation MIME** | finfo_file() côté serveur |
| **Magic bytes** | Vérifier la signature réelle |
| **Taille** | Limite 5 Mo |
| **Nom de fichier** | UUID aléatoire (pas le nom original) |
| **Antivirus** | ClamAV scan |
| **Permissions** | chmod 0640 (lecture seule) |
| **Emplacement** | Hors webroot si possible |
| **Exécution** | Désactivée (php_flag engine off) |

---

:::tip Prochaine Section
**15.8 Validation des Entrées** : Validation côté serveur obligatoire.
:::