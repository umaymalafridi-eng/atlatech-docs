---
title: Logs CRUD
sidebar_label: "19.2 Logs CRUD"
sidebar_position: 2
---

# 19.2 Logs CRUD (Modifications Employés)

## Table de logs déjà créée

**Référence chapitre 16.9 :**

```sql
CREATE TABLE logs_audit (
    log_id INT AUTO_INCREMENT PRIMARY KEY,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    user VARCHAR(50),
    host VARCHAR(45),
    action ENUM('INSERT','UPDATE','DELETE','SELECT'),
    table_name VARCHAR(50),
    record_id INT,
    old_values TEXT,
    new_values TEXT,
    details TEXT
);
```

## Déclencheurs (Triggers) automatiques

**Trigger UPDATE :**

```sql
DELIMITER //
CREATE TRIGGER trg_audit_employes_update
AFTER UPDATE ON employes
FOR EACH ROW
BEGIN
    INSERT INTO logs_audit (user, action, table_name, record_id, old_values, new_values)
    VALUES (
        USER(),
        'UPDATE',
        'employes',
        NEW.id,
        CONCAT('salaire:', OLD.salaire, ',poste:', OLD.poste),
        CONCAT('salaire:', NEW.salaire, ',poste:', NEW.poste)
    );
END//
DELIMITER ;
```

## Rapports d'audit

**Qui a modifié quoi aujourd'hui :**

```sql
SELECT 
    timestamp,
    user,
    action,
    record_id,
    old_values,
    new_values
FROM logs_audit
WHERE DATE(timestamp) = CURDATE()
AND table_name = 'employes'
ORDER BY timestamp DESC;
```

**Export pour conformité GDPR :**

```bash
sudo mysql -u root atlastech_db -e \
"SELECT * FROM logs_audit WHERE table_name='employes'" \
> /var/backups/audit_$(date +%Y%m%d).csv
```